<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Economy & Politics MCQ Quiz</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall look */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* Changed to column to stack header and content */
            justify-content: flex-start; /* Align items to the start of the cross axis */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-top: 80px; /* Space for the fixed header (approximate height) */
            box-sizing: border-box;
            position: relative;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            overflow-y: auto; /* Allow vertical scrolling */
            background-color: #1a202c; /* Ensure body has a dark background for contrast */
        }

        /* Background Video Styles */
        #background-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%; /* Keep for robustness */
            min-height: 100%; /* Keep for robustness */
            width: 100vw; /* Explicitly set to viewport width */
            height: 100vh; /* Explicitly set to viewport height */
            object-fit: cover; /* Correct property for video to cover its container */
            z-index: -1; /* Place behind all content */
            filter: brightness(50%); /* Darken the video to improve text readability */
        }

        /* Global Header Styles */
        .main-header {
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.05); /* Lighter transparent background */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            color: white; /* Default text color for header */
            min-height: 60px; /* Ensure a minimum height */
        }

        .main-header .logo {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 1px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .main-header .logo img {
            height: 40px; /* Adjust logo size */
            width: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .main-header .user-profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .main-header .user-profile-section .user-display-name {
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap; /* Prevent name from wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px; /* Limit width for long names */
        }

        .main-header .user-profile-section .profile-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #818cf8; /* Indigo border for profile pic */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .main-header .user-profile-section .profile-photo:hover {
            transform: scale(1.05);
        }

        /* Responsive adjustments for header */
        @media (max-width: 768px) {
            .main-header {
                padding: 10px 20px;
            }
            .main-header .logo {
                font-size: 20px;
                gap: 5px;
            }
            .main-header .logo img {
                height: 30px;
                width: 30px;
            }
            .main-header .user-profile-section {
                gap: 10px;
            }
            .main-header .user-profile-section .user-display-name {
                font-size: 0.9rem;
                max-width: 100px;
            }
            .main-header .user-profile-section .profile-photo {
                width: 35px;
                height: 35px;
            }
            .main-header .logout-button-class {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
        }


        /* Glassmorphism for all main content containers (excluding splash-screen) */
        .quiz-container, .subject-selection-container, .question-count-container, .user-data-container, .user-profile-container, .home-screen-container, .result-summary-container, .solution-explanation-container, .settings-container, .extra-features-container, .ga-subjects-container, .reasoning-subjects-container, .quantitative-aptitude-subjects-container, .english-language-subjects-container, .computer-knowledge-subjects-container, .general-studies-subjects-container, .current-affairs-subjects-container, .mock-test-zone-subjects-container, .auth-container {
            background: rgba(0, 0, 0, 0.3); /* Darker semi-transparent background */
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Soft shadow */
            backdrop-filter: blur(10px); /* Glassmorphism blur */
            -webkit-backdrop-filter: blur(10px); /* Safari support */
            border: 1px solid rgba(255, 255, 255, 0.18); /* Subtle white border */
            color: white; /* Default text color for dark theme */
            padding: 2.5rem;
            max-width: 600px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
            z-index: 1;
            margin-bottom: 20px;
            overflow: hidden; /* Hide overflow for gradient effect */
        }

        /* Gradient lighting effect for auth-container (and now all main containers, excluding splash-screen) */
        .auth-container::before, .quiz-container::before, .subject-selection-container::before, .question-count-container::before, .user-data-container::before, .user-profile-container::before, .home-screen-container::before, .result-summary-container::before, .solution-explanation-container::before, .settings-container::before, .extra-features-container::before, .ga-subjects-container::before, .reasoning-subjects-container::before, .quantitative-aptitude-subjects-container::before, .english-language-subjects-container::before, .computer-knowledge-subjects-container::before, .general-studies-subjects-container::before, .current-affairs-subjects-container::before, .mock-test-zone-subjects-container::before {
            content: '';
            position: absolute;
            top: -150%;
            left: -150%;
            width: 400%;
            height: 400%;
            background: radial-gradient(circle at 50% 50%, rgba(100, 200, 255, 0.1), transparent 80%);
            animation: rotateGradient 15s linear infinite;
            z-index: -1;
            opacity: 0.3;
        }

        @keyframes rotateGradient {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Splash Screen Styles - now with glassmorphism */
        .splash-screen {
            /* Full screen overlay properties */
            height: 100vh;
            width: 100vw;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            
            /* Centering content */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* Ensure content stacks vertically */
            gap: 2rem;

            /* Glassmorphism-like background */
            background: rgba(0, 0, 0, 0.5); /* Slightly more opaque for better content visibility */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* No border-radius or box-shadow for full screen overlay */
            
            /* Text color and transition */
            color: white;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interactions when hidden */
        }
        .splash-screen img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            animation: scaleIn 0.8s ease-out forwards; /* Apply scale-in animation */
        }
        .splash-screen .tagline {
            font-size: 2.2rem;
            font-weight: 700;
            margin-top: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            /* Removed previous animation from here */
            display: flex; /* To arrange words horizontally */
            gap: 0.5rem; /* Space between words */
            flex-wrap: wrap; /* Allow wrapping if text is too long */
            justify-content: center; /* Center words */
        }

        .splash-screen .tagline span {
            opacity: 0; /* Start hidden for individual animations */
        }

        /* New Keyframe Animations for individual words */
        @keyframes slideInLeft {
            from {
                transform: translateX(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInTop {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInBottom {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Apply new animations to individual words */
        .splash-screen .tagline .word-practice {
            animation: slideInLeft 0.7s ease-out forwards;
        }
        .splash-screen .tagline .word-smart {
            animation: slideInTop 0.7s ease-out 0.2s forwards; /* 0.2s delay */
        }
        .splash-screen .tagline .word-crack {
            animation: slideInRight 0.7s ease-out 0.4s forwards; /* 0.4s delay */
        }
        .splash-screen .tagline .word-ssc {
            animation: slideInBottom 0.7s ease-out 0.6s forwards; /* 0.6s delay */
        }

        /* Keyframe Animations (existing) */
        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Home Screen Styles */
        .home-screen-container {
            /* Removed absolute positioning for profile icon, now handled by global header */
        }
        .home-screen-container h1,
        .home-screen-container h2,
        .home-screen-container h3,
        .home-screen-container p {
            color: white; /* Ensure all text in home screen is white */
        }
        .quick-access-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .quick-access-card {
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism background */
            padding: 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Glassmorphism border */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        .quick-access-card:hover {
            background-color: rgba(255, 255, 255, 0.2); /* Darker on hover */
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Stronger shadow on hover */
        }
        .quick-access-card .icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #818cf8; /* Indigo for icons */
        }
        .home-screen-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            justify-content: center; /* Center buttons when wrapped */
        }
        .home-screen-buttons .glass-button-primary {
            flex: 1;
            min-width: 180px; /* Ensure buttons don't get too small */
        }


        .question-text {
            font-size: 1.5rem; /* Larger font size */
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
            margin-bottom: 1.5rem;
        }

        /* Base Glassmorphism Button Style */
        .glass-button-base {
            padding: 0.8rem 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            display: block; /* Default to block for full width */
            width: 100%; /* Default to full width */
            margin-bottom: 0.8rem; /* Space between buttons */
            display: flex; /* For centering content, especially with icons */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* For spacing between icon and text */
        }
        .glass-button-base:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }
        .glass-button-base:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .glass-button-base:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Specific Button Styles */
        .glass-button-default {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-button-default:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4); /* Keep subtle border change on hover */
        }

        .glass-button-primary {
            background-color: #4c51bf; /* Indigo */
            color: white;
            border: none; /* Override base border for solid look */
        }
        .glass-button-primary:hover:not(:disabled) {
            background-color: #4338ca; /* Darker indigo */
        }

        .glass-button-orange {
            background-color: #ed8936; /* Orange */
            color: white;
            border: none;
        }
        .glass-button-orange:hover:not(:disabled) {
            background-color: #dd6b20; /* Darker orange */
        }

        .glass-button-green {
            background-color: #38a169; /* Green */
            color: white;
            border: none;
        }
        .glass-button-green:hover:not(:disabled) {
            background-color: #2f855a; /* Darker green */
        }

        .glass-button-danger {
            background-color: #ef4444; /* Red */
            color: white;
            border: none;
        }
        .glass-button-danger:hover:not(:disabled) {
            background-color: #dc2626; /* Darker red */
        }

        .glass-button-light {
            background-color: white;
            color: #1a202c; /* Dark text */
            font-weight: bold;
            border: none;
        }
        .glass-button-light:hover:not(:disabled) {
            background-color: #f0f0f0; /* Slightly darker white */
        }

        /* Special styles for correct/incorrect options in quiz */
        .option-button.correct {
            background-color: rgba(167, 243, 208, 0.3); /* Green for correct with transparency */
            border-color: #34d399;
            color: white; /* Keep text white */
        }
        .option-button.incorrect {
            background-color: rgba(254, 202, 202, 0.3); /* Red for incorrect with transparency */
            border-color: #ef4444;
            color: white; /* Keep text white */
        }

        /* Auth Toggle Buttons (Sign up / Sign in) - specific styling, not using general glass-button-base */
        .auth-toggle-buttons {
            display: flex;
            gap: 0.5rem; /* Reduced gap */
            background-color: rgba(255, 255, 255, 0.05); /* Very subtle transparent background */
            border-radius: 0.75rem;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .auth-toggle-buttons .toggle-auth-button {
            flex: 1;
            padding: 0.7rem 1.2rem;
            border-radius: 0.6rem; /* Slightly smaller radius than container */
            background-color: transparent;
            color: rgba(255, 255, 255, 0.7); /* Lighter white for inactive */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .auth-toggle-buttons .toggle-auth-button.active {
            background-color: rgba(255, 255, 255, 0.15); /* More opaque white when active */
            color: white; /* Solid white for active */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .auth-toggle-buttons .toggle-auth-button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .feedback-message {
            margin-top: 1rem;
            font-size: 1.2rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .correct-answer-display {
            margin-top: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #68d391; /* Green for correct answer text */
        }
        .timer-display {
            font-size: 2rem; /* Larger timer */
            font-weight: 700;
            color: #f87171; /* Red for timer */
            margin-bottom: 1rem;
        }
        .quiz-navigation-buttons {
            display: flex;
            gap: 1rem; /* Space between buttons */
            margin-top: 1.5rem;
            justify-content: center; /* Center the buttons */
        }
        .quiz-navigation-buttons .glass-button-primary {
            flex: 1; /* Make buttons take equal width */
            margin-bottom: 0; /* Override default margin for flex container */
        }
        .quiz-finished-message {
            font-size: 1.8rem;
            font-weight: 700;
            color: #68d391; /* Green for success */
            margin-top: 2rem;
        }
        .quiz-summary {
            text-align: left;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Lighter border */
        }
        .quiz-summary p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .quiz-summary p span {
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
        }
        .question-count-input, .profile-input, .settings-input {
            width: 100%;
            padding: 0.8rem;
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism input */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Glassmorphism border */
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: white; /* Changed for glassmorphism */
            text-align: center;
            margin-bottom: 1rem;
        }
        .question-count-input::placeholder, .profile-input::placeholder, .settings-input::placeholder {
            color: rgba(255, 255, 255, 0.7); /* Lighter placeholder */
        }
        .question-count-input:focus, .profile-input:focus, .settings-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        .error-message {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }
        /* Removed .user-info-container styles as it's being replaced by global header */
        .auth-input-group {
            margin-bottom: 1rem;
        }
        .auth-input-group label {
            display: block;
            text-align: left;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: white; /* Already white */
        }

        /* Auth Inputs (already glassmorphism, but ensuring consistency) */
        .auth-input {
            width: 100%;
            padding: 0.8rem;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            font-size: 1.1rem;
            color: white;
            text-align: left;
            transition: all 0.2s ease-in-out;
        }
        .auth-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .auth-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        .auth-input-phone-group {
            display: flex;
            gap: 0.5rem;
        }
        .auth-input-phone-group select {
            flex-shrink: 0;
            width: 80px; /* Fixed width for country code dropdown */
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            color: white;
            padding: 0.8rem;
            font-size: 1.1rem;
        }
        .auth-input-phone-group input {
            flex-grow: 1;
        }


        .auth-button-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .auth-button-group .glass-button-base {
            flex: 1;
            margin-bottom: 0; /* Override default margin */
        }

        /* Redesigned Auth Buttons (already glassmorphism) */
        /* .auth-button class is now replaced by glass-button-base and specific color classes */

        /* Specific button styles */
        /* These styles will now be applied via the new glass-button-X classes */

        #auth-main-title, #auth-intro-text {
            color: white; /* Ensure these are white */
        }


        /* Terms of Service Note */
        .terms-note {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 1.5rem;
            line-height: 1.4;
        }
        .terms-note a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: underline;
        }
        .terms-note a:hover {
            color: white;
        }

        /* Styles for user data display */
        .user-data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .user-data-table th, .user-data-table td {
            border: 1px solid rgba(255, 255, 255, 0.1); /* Glassmorphism border */
            padding: 0.8rem;
            text-align: left;
            font-size: 0.95rem;
            color: white; /* Changed for glassmorphism */
        }
        .user-data-table th {
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism background */
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
        }
        .user-data-table tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05); /* Slightly different shade */
        }
        .user-data-table tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.15); /* Darker on hover */
        }
        .streak-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: #818cf8; /* Indigo for streak */
            margin-bottom: 1rem;
        }
        .profile-info {
            margin-top: 1.5rem;
            text-align: left;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center profile content */
        }
        .profile-info img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 3px solid #4c51bf; /* Border around profile pic */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .profile-info p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .profile-info p span {
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
        }
        .profile-field-group { /* New style for input groups in profile */
            width: 100%;
            margin-bottom: 1rem;
            text-align: left;
        }
        .profile-field-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .profile-message { /* New style for profile messages */
            font-size: 1rem;
            margin-top: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .profile-intro-text { /* New style for the intro text */
            text-align: left;
            margin-bottom: 1.5rem;
            color: white; /* Already white */
        }
        .profile-intro-text h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: white; /* Already white */
            margin-bottom: 0.8rem;
        }
        .profile-intro-text p {
            font-size: 1rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.8); /* Lighter white for body text */
        }
        .profile-intro-text ul {
            list-style: disc;
            margin-left: 20px;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .profile-intro-text li {
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        
        /* Result Summary Page Styles */
        .result-summary-container h1,
        .result-summary-container p {
            color: white; /* Ensure all text in result summary is white */
        }
        .result-summary-container p span {
            color: white; /* Ensure all text in result summary is white */
        }
        .result-summary-container .score-percentage {
            font-size: 3rem;
            font-weight: 800;
            color: #818cf8; /* Indigo for score */
            margin: 1.5rem 0;
        }
        .result-summary-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }
        .result-summary-buttons .glass-button-primary {
            /* Specific overrides for result buttons */
            margin-bottom: 0; /* Remove extra margin from base */
        }
        /* These specific color classes are now applied directly to buttons */
        /* .result-summary-buttons .next-button.retry {
            background-color: #38a169;
            color: white;
        }
        .result-summary-buttons .next-button.share {
            background-color: #ed8936;
            color: white;
        } */
        /* .result-summary-buttons .next-button:hover {
            opacity: 0.9;
        } */

        /* Solution/Explanation Page Styles */
        .solution-explanation-container h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white; /* Changed for glassmorphism */
            margin-bottom: 1.5rem;
        }
        .solution-item {
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism background */
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Glassmorphism border */
            color: white; /* Changed for glassmorphism */
        }
        .solution-item .solution-q-text {
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
        }
        .solution-item .solution-a-text {
            font-weight: 600;
            color: #68d391; /* Green for correct answer */
        }
        .solution-item .solution-exp-text {
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
        }
        .solution-item .solution-learn-more {
            color: #818cf8; /* Indigo for learn more */
            text-decoration: underline;
            margin-top: 0.5rem;
            display: inline-block;
        }
        .solution-item .solution-learn-more:hover {
            color: #6366f1; /* Darker indigo on hover */
        }
        .solutions-list-container {
            max-height: 400px; /* Limit height for scrollability */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 10px; /* Space for scrollbar */
            margin-bottom: 1.5rem;
        }

        /* Profile Page Specific Styles */
        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 2rem;
        }
        .profile-stat-card {
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism background */
            padding: 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: white; /* Changed for glassmorphism */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Glassmorphism border */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        .profile-stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #818cf8; /* Indigo for stat value */
        }
        .weak-areas-list {
            list-style: disc;
            margin-left: 20px;
            text-align: left;
            color: #f87171; /* Red for weak areas */
            font-weight: 500;
        }
        .weak-areas-section {
            margin-top: 1.5rem;
            text-align: left;
        }
        .weak-areas-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white; /* Changed for glassmorphism */
            margin-bottom: 0.8rem;
        }
        .profile-buttons-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }
        .profile-buttons-group .glass-button-base {
            margin-bottom: 0; /* Override default margin for flex container */
        }
        /* Settings Page Specific Styles */
        .settings-container h1,
        .settings-option label {
            color: white; /* Ensure all text in settings is white */
        }
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Lighter border */
        }
        .settings-option:last-child {
            border-bottom: none;
        }
        .settings-option label {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8); /* Changed for glassmorphism */
            font-weight: 500;
        }
        .settings-option select, .settings-option input[type="checkbox"] {
            margin-left: 1rem;
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism background */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Glassmorphism border */
            color: white; /* Changed for glassmorphism */
            border-radius: 0.5rem; /* Rounded corners for select */
            padding: 0.4rem;
        }
        .settings-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .settings-option .glass-button-primary {
            /* Specific override for settings button */
            margin-bottom: 0; /* Remove extra margin from base */
        }
        /* Extra Features Page Specific Styles */
        .extra-features-container h1 {
            color: white; /* Ensure heading is white */
        }
        .feature-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem;
            background-color: rgba(255, 255, 255, 0.1); /* Glassmorphism background */
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Glassmorphism border */
            font-size: 1.1rem;
            color: white; /* Changed for glassmorphism */
            font-weight: 500;
            text-align: left;
        }
        .feature-item .icon {
            font-size: 1.8rem;
            color: #818cf8; /* Indigo for icons */
        }

        /* Styles for Gemini Explanation */
        .gemini-explanation-area {
            margin-top: 1rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.08); /* Slightly lighter glassmorphism */
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: left;
            line-height: 1.5;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            word-wrap: break-word; /* Break long words */
        }

        /* Styles for automatic Gemini explanation on wrong answer */
        .auto-gemini-explanation-area {
            margin-top: 1rem;
            padding: 1.5rem; /* Increased padding for better readability */
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem; /* Slightly more rounded */
            border: 1px solid rgba(255, 255, 255, 0.15); /* Slightly stronger border */
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.9);
            text-align: left;
            line-height: 1.6; /* Increased line height */
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Added subtle shadow */
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #818cf8; /* Indigo spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto; /* Center the spinner */
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Background Video -->
    <video autoplay muted loop playsinline id="background-video">
        <source src="bg.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Global Header -->
    <header class="main-header" id="main-header" style="display: none;">
        <div class="logo">
            <img src="image.png" alt="Logo">
            HiVal
        </div>
        <div class="user-profile-section">
            <span id="header-user-display-name" class="user-display-name"></span>
            <img id="header-profile-photo" src="https://placehold.co/40x40/cccccc/333333?text=👤" alt="Profile" class="profile-photo">
        </div>
    </header>

    <!-- Splash Screen -->
    <div class="splash-screen" id="splash-screen">
        <img src="image.png" alt="SSC KNOCKOUT Logo">
        <div class="tagline">
            <span class="word-practice">Practice</span>
            <span class="word-smart">Smart,</span>
            <span class="word-crack">Crack</span>
            <span class="word-ssc">Exam</span>
        </div>
    </div>

    <!-- Authentication Container (Login/Signup) -->
    <div class="auth-container" id="auth-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6" id="auth-main-title">Welcome to the Quiz App!</h1>
        <p class="text-lg mb-4" id="auth-intro-text">Please log in or sign up to continue.</p>

        <div class="auth-toggle-buttons">
            <button id="show-login-button" class="toggle-auth-button active">Sign In</button>
            <button id="show-signup-button" class="toggle-auth-button">Sign Up</button>
        </div>

        <!-- Login Form Section -->
        <div id="login-form-section" class="auth-form-section active">
            <div class="auth-input-group">
                <label for="login-email-input">Email:</label>
                <input type="email" id="login-email-input" class="auth-input" placeholder="your@example.com">
            </div>
            <div class="auth-input-group">
                <label for="login-password-input">Password:</label>
                <input type="password" id="login-password-input" class="auth-input" placeholder="********">
            </div>
            <p id="auth-error-message" class="error-message" style="display: none;"></p>

            <button id="email-login-button" class="glass-button-base glass-button-primary">Sign In with Email</button>
            <button id="forgot-password-button" class="glass-button-base glass-button-orange mt-4">Forgot Password?</button>
            
            <div class="my-6 text-gray-500">OR</div>

            <button id="google-login-button" class="glass-button-base glass-button-default">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" class="w-5 h-5 inline-block mr-2">
                Sign In with Google
            </button>
            <button id="anonymous-login-button" class="glass-button-base glass-button-default">
                <span class="text-xl mr-2">👤</span>
                Sign In Anonymously
            </button>
            <button id="apple-login-button" class="glass-button-base glass-button-default">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/apple.svg" alt="Apple logo" class="w-5 h-5 inline-block mr-2">
                Sign In with Apple
            </button>
        </div>

        <!-- Sign Up Form Section -->
        <div id="signup-form-section" class="auth-form-section">
            <div class="profile-intro-text">
                <p>Let’s get started with setting up your profile.</p>
                <p>Please fill in the following details:</p>
            </div>

            <div class="auth-input-group">
                <label for="signup-first-name-input">👤 First Name:</label>
                <input type="text" id="signup-first-name-input" class="auth-input" placeholder="Your First Name">
            </div>
            <div class="auth-input-group">
                <label for="signup-last-name-input">👤 Last Name:</label>
                <input type="text" id="signup-last-name-input" class="auth-input" placeholder="Your Last Name">
            </div>
            
            <div class="auth-input-group">
                <label for="signup-email-input">📧 Email Address:</label>
                <input type="email" id="signup-email-input" class="auth-input" placeholder="your@example.com">
            </div>

            <div class="auth-input-group">
                <label for="signup-phone-input">📱 Phone Number:</label>
                <div class="auth-input-phone-group">
                    <select id="signup-country-code-input">
                        <option value="+1">+1 (USA/Canada)</option>
                        <option value="+91" selected>+91 (India)</option>
                        <option value="+44">+44 (UK)</option>
                        <option value="+61">+61 (Australia)</option>
                        <option value="+49">+49 (Germany)</option>
                        <option value="+33">+33 (France)</option>
                        <!-- Add more country codes as needed -->
                    </select>
                    <input type="tel" id="signup-phone-input" class="auth-input" placeholder="e.g., 9876543210">
                </div>
            </div>

            <div class="auth-input-group">
                <label for="signup-password-input">🔒 Password:</label>
                <input type="password" id="signup-password-input" class="auth-input" placeholder="********">
            </div>

            <div class="auth-input-group">
                <label for="signup-confirm-password-input">🔒 Confirm Password:</label>
                <input type="password" id="signup-confirm-password-input" class="auth-input" placeholder="********">
            </div>

            <div class="auth-input-group">
                <label for="signup-age-input">🎂 Age (Optional):</label>
                <input type="number" id="signup-age-input" class="auth-input" placeholder="e.g., 30" min="1">
            </div>

            <div class="auth-input-group">
                <label for="signup-gender-input">🚻 Gender (Optional):</label>
                <select id="signup-gender-input" class="auth-input">
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
            </div>

            <div class="auth-input-group">
                <label for="signup-about-you-input">🗣️ About You (Optional):</label>
                <textarea id="signup-about-you-input" class="auth-input" rows="3" placeholder="Tell us a little about yourself..."></textarea>
            </div>

            <p id="auth-error-message-signup" class="error-message" style="display: none;"></p>

            <button id="email-signup-button" class="glass-button-base glass-button-light">Create an account</button>
            
            <div class="my-6 text-gray-500">OR</div>

            <button id="google-signup-button" class="glass-button-base glass-button-default">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" class="w-5 h-5 inline-block mr-2">
                Sign Up with Google
            </button>
            <button id="apple-signup-button" class="glass-button-base glass-button-default">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/apple.svg" alt="Apple logo" class="w-5 h-5 inline-block mr-2">
                Sign Up with Apple
            </button>

            <p class="terms-note">
                By creating an account, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>.
            </p>
        </div>
    </div>

    <!-- Home Screen -->
    <div class="home-screen-container" id="home-screen-container" style="display: none;">
        <!-- Profile Icon removed from here, now in global header -->
        <h1 class="text-3xl font-bold mb-6">Hello, <span id="welcome-user-name">User</span> 👋 Ready to Practice?</h1>
        
        <h2 class="text-2xl font-bold mb-4">📌 Quick Access: Choose a Subject to Practice</h2>
        <p class="text-lg mb-4"></p>

        <h3 class="text-xl font-bold mt-6 mb-3 text-left">🔹 Core Sections</h3>
        <div class="quick-access-grid">
            <div class="quick-access-card" id="card-general-awareness">
                <span class="icon">📘</span>
                General Awareness
                <span class="text-sm text-gray-500">Static GK, Current Affairs, Polity, History, Geography, Science & Economy</span>
            </div>
            <div class="quick-access-card" id="card-reasoning">
                <span class="icon">🧠</span>
                Reasoning (General Intelligence)
                <span class="text-sm text-gray-500">Analogy, Series, Puzzles, Coding-Decoding, Blood Relations & more</span>
            </div>
            <div class="quick-access-card" id="card-quantitative-aptitude">
                <span class="icon">📐</span>
                Quantitative Aptitude (Maths)
                <span class="text-sm text-gray-500">Arithmetic, Algebra, Geometry, Mensuration, Trigonometry & DI</span>
            </div>
            <div class="quick-access-card" id="card-english-language">
                <span class="icon">📚</span>
                English Language
                <span class="text-sm text-gray-500">Vocabulary, Grammar, Reading Comprehension, Cloze Test & Spot the Error</span>
            </div>
        </div>

        <h3 class="text-xl font-bold mt-6 mb-3 text-left">🔸 Optional / Add-on Sections</h3>
        <div class="quick-access-grid">
            <div class="quick-access-card" id="card-computer-knowledge">
                <span class="icon">🖥️</span>
                Computer Knowledge
                <span class="text-sm text-gray-500">Basics of Computer, Internet, MS Office, Abbreviations</span>
            </div>
            <div class="quick-access-card" id="card-general-studies">
                <span class="icon">💼</span>
                General Studies (JE / Tier 2)
                <span class="text-sm text-gray-500">Engineering Subjects, Advanced Economics & Polity</span>
            </div>
            <div class="quick-access-card" id="card-current-affairs">
                <span class="icon">📅</span>
                Current Affairs
                <span class="text-sm text-gray-500">Daily Quizzes, Budget, Govt Schemes, Monthly PDFs</span>
            </div>
            <div class="quick-access-card" id="card-mock-test-zone">
                <span class="icon">🎯</span>
                Mock Test Zone
                <span class="text-sm text-gray-500">Full-length SSC CGL/CHSL/MTS mocks, Sectional & Tier-wise tests</span>
            </div>
        </div>

        <div class="home-screen-buttons">
            <button id="extra-features-button" class="glass-button-base glass-button-primary">Extra Features</button>
        </div>
    </div>

    <!-- Subject Selection Container (for individual GA subjects) -->
    <div class="subject-selection-container" id="subject-selection-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Choose Your Quiz Subject</h1>
        <button id="economy-button" class="glass-button-base glass-button-default">Indian Economy</button>
        <button id="politics-button" class="glass-button-base glass-button-default">Indian Politics</button>
        <button id="history-button" class="glass-button-base glass-button-default">Indian History</button>
        <button id="geography-button" class="glass-button-base glass-button-default">Geography</button>
        <button id="view-activity-button" class="glass-button-base glass-button-primary mt-4">View My Activity</button>
        <button id="view-profile-button" class="glass-button-base glass-button-primary mt-2">View My Profile</button>
    </div>

    <!-- General Awareness Sub-subjects Container -->
    <div class="ga-subjects-container" id="ga-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">General Awareness: Select Topic</h1>
        <button id="ga-static-gk-button" class="glass-button-base glass-button-default">Static GK</button>
        <button id="ga-current-affairs-button" class="glass-button-base glass-button-default">Current Affairs</button>
        <button id="ga-polity-button" class="glass-button-base glass-button-default">Polity</button>
        <button id="ga-history-button" class="glass-button-base glass-button-default">History</button>
        <button id="ga-geography-button" class="glass-button-base glass-button-default">Geography</button>
        <button id="ga-science-button" class="glass-button-base glass-button-default">Science</button>
        <button id="ga-economy-button" class="glass-button-base glass-button-default">Economy</button>
        <button id="back-to-home-from-ga-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- Reasoning Sub-subjects Container -->
    <div class="reasoning-subjects-container" id="reasoning-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Reasoning: Select Topic</h1>
        <button id="reasoning-analogy-button" class="glass-button-base glass-button-default">Analogy</button>
        <button id="reasoning-series-button" class="glass-button-base glass-button-default">Series</button>
        <button id="reasoning-puzzles-button" class="glass-button-base glass-button-default">Puzzles</button>
        <button id="reasoning-coding-decoding-button" class="glass-button-base glass-button-default">Coding-Decoding</button>
        <button id="reasoning-blood-relations-button" class="glass-button-base glass-button-default">Blood Relations</button>
        <button id="back-to-home-from-reasoning-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- Quantitative Aptitude Sub-subjects Container -->
    <div class="quantitative-aptitude-subjects-container" id="quantitative-aptitude-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Quantitative Aptitude: Select Topic</h1>
        <button id="quant-arithmetic-button" class="glass-button-base glass-button-default">Arithmetic</button>
        <button id="quant-algebra-button" class="glass-button-base glass-button-default">Algebra</button>
        <button id="quant-geometry-button" class="glass-button-base glass-button-default">Geometry</button>
        <button id="quant-mensuration-button" class="glass-button-base glass-button-default">Mensuration</button>
        <button id="quant-trigonometry-button" class="glass-button-base glass-button-default">Trigonometry</button>
        <button id="quant-di-button" class="glass-button-base glass-button-default">Data Interpretation</button>
        <button id="back-to-home-from-quant-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- English Language Sub-subjects Container -->
    <div class="english-language-subjects-container" id="english-language-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">English Language: Select Topic</h1>
        <button id="english-vocabulary-button" class="glass-button-base glass-button-default">Vocabulary</button>
        <button id="english-grammar-button" class="glass-button-base glass-button-default">Grammar</button>
        <button id="english-reading-comprehension-button" class="glass-button-base glass-button-default">Reading Comprehension</button>
        <button id="english-cloze-test-button" class="glass-button-base glass-button-default">Cloze Test</button>
        <button id="english-spot-error-button" class="glass-button-base glass-button-default">Spot the Error</button>
        <button id="back-to-home-from-english-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- Computer Knowledge Sub-subjects Container -->
    <div class="computer-knowledge-subjects-container" id="computer-knowledge-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Computer Knowledge: Select Topic</h1>
        <button id="computer-basics-button" class="glass-button-base glass-button-default">Basics of Computer</button>
        <button id="computer-internet-button" class="glass-button-base glass-button-default">Internet</button>
        <button id="computer-ms-office-button" class="glass-button-base glass-button-default">MS Office</button>
        <button id="computer-abbreviations-button" class="glass-button-base glass-button-default">Abbreviations</button>
        <button id="back-to-home-from-computer-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- General Studies Sub-subjects Container -->
    <div class="general-studies-subjects-container" id="general-studies-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">General Studies: Select Topic</h1>
        <button id="gs-engineering-button" class="glass-button-base glass-button-default">Engineering Subjects</button>
        <button id="gs-advanced-economy-button" class="glass-button-base glass-button-default">Advanced Economics</button>
        <button id="gs-advanced-polity-button" class="glass-button-base glass-button-default">Advanced Polity</button>
        <button id="back-to-home-from-general-studies-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- Current Affairs Sub-subjects Container -->
    <div class="current-affairs-subjects-container" id="current-affairs-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Current Affairs: Select Topic</h1>
        <button id="ca-daily-quizzes-button" class="glass-button-base glass-button-default">Daily Quizzes</button>
        <button id="ca-budget-button" class="glass-button-base glass-button-default">Budget</button>
        <button id="ca-govt-schemes-button" class="glass-button-base glass-button-default">Government Schemes</button>
        <button id="ca-monthly-pdfs-button" class="glass-button-base glass-button-default">Monthly PDFs</button>
        <button id="back-to-home-from-current-affairs-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- Mock Test Zone Sub-subjects Container -->
    <div class="mock-test-zone-subjects-container" id="mock-test-zone-subjects-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Mock Test Zone: Select Test Type</h1>
        <button id="mtz-full-length-mocks-button" class="glass-button-base glass-button-default">Full Length Mocks</button>
        <button id="mtz-sectional-tests-button" class="glass-button-base glass-button-default">Sectional Tests</button>
        <button id="mtz-tier-wise-tests-button" class="glass-button-base glass-button-default">Tier-wise Tests</button>
        <button id="back-to-home-from-mock-test-zone-subjects" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <!-- Question Count Selection Container -->
    <div class="question-count-container" id="question-count-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-4">Practice <span id="selected-subject-title"></span></h1>
        <p class="text-lg mb-4">Total questions available: <span id="total-available-questions" class="font-bold"></span></p>
        <label for="num-questions" class="block text-lg font-medium mb-2">How many questions do you want to practice?</label>
        <input type="number" id="num-questions" class="question-count-input" min="1" value="5">
        <p id="question-count-error" class="error-message" style="display: none;"></p>
        <button id="start-practice-button" class="glass-button-base glass-button-primary">Start Practice</button>
        <button id="back-to-subject-selection-from-question-count" class="glass-button-base glass-button-primary mt-6">Back to Subject Selection</button>
    </div>

    <!-- Quiz Container (Practice/Test Module Page) -->
    <div class="quiz-container" id="quiz-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-4">
            <span id="quiz-subject-title"></span>
        </h1>

        <div class="flex justify-center items-center gap-2 mb-4">
            <span class="text-2xl font-bold">⏱ Timer:</span>
            <span id="timer-display" class="timer-display">20</span>
            <span class="text-lg">seconds/question</span>
        </div>

        <div id="question-display" class="question-text"></div>

        <div id="options-container" class="flex flex-col gap-3">
            <!-- Options will be dynamically inserted here -->
        </div>

        <div id="feedback-area" class="feedback-message"></div>
        <div id="correct-answer-area" class="correct-answer-area"></div>
        <!-- New area for automatic Gemini explanation -->
        <div id="auto-gemini-explanation-area" class="auto-gemini-explanation-area" style="display: none;"></div>

        <div class="quiz-navigation-buttons">
            <button id="back-to-question-count-from-quiz" class="glass-button-base glass-button-primary">Back to Question Count</button>
            <button id="next-button" class="glass-button-base glass-button-primary" disabled>Next Question</button>
            <button id="show-result-button" class="glass-button-base glass-button-primary">Show Result</button>
        </div>
    </div>

    <!-- Result Summary Page -->
    <div class="result-summary-container" id="result-summary-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Quiz Results</h1>
        <p>Subject: <span id="result-subject"></span></p>
        <p>Total Questions: <span id="result-total-questions"></span></p>
        <p>Correct Answers: <span id="result-correct-count" class="text-green-600"></span></p>
        <p>Incorrect Answers: <span id="result-incorrect-count" class="text-red-600"></span></p>
        <p>Time Taken: <span id="result-time-taken"></span> seconds</p>
        <p class="score-percentage" id="result-score-percentage">0%</p>

        <div class="result-summary-buttons">
            <button id="view-solutions-button" class="glass-button-base glass-button-primary">View Solutions</button>
            <button id="retry-test-button" class="glass-button-base glass-button-green">Retry Test</button>
            <button id="share-score-button" class="glass-button-base glass-button-orange">Share Score</button>
            <button id="back-to-question-count-from-result" class="glass-button-base glass-button-primary">Back to Question Count</button>
        </div>
    </div>

    <!-- Solution/Explanation Page -->
    <div class="solution-explanation-container" id="solution-explanation-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Solutions & Explanations</h1>
        <div id="solutions-list" class="solutions-list-container">
            <!-- Solutions will be dynamically inserted here -->
        </div>
        <button id="back-to-results-button" class="glass-button-base glass-button-primary mt-2">Back to Results</button>
    </div>


    <!-- User Data Container (Activity & Results) -->
    <div class="user-data-container" id="user-data-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Your Activity & Results</h1>
        <p class="streak-display">Current Daily Streak: <span id="current-streak-display">0</span> 🔥</p>
        <h2 class="text-2xl font-bold mb-4">Past Quiz Attempts</h2>
        <div id="past-attempts-list">
            <p class="text-gray-600">Loading your past quiz attempts...</p>
        </div>
        <button id="back-to-quiz-selection" class="glass-button-base glass-button-primary mt-6">Back to Quiz Selection</button>
    </div>

    <!-- User Profile Container -->
    <div class="user-profile-container" id="user-profile-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">My Profile</h1>
        <div class="profile-info">
            <img id="profile-photo" src="https://placehold.co/120x120/cccccc/333333?text=No+Photo" alt="Profile Photo">
            
            <div class="profile-field-group">
                <label for="edit-display-name-input">Full Name:</label>
                <input type="text" id="edit-display-name-input" class="profile-input" placeholder="Your Full Name">
            </div>
            
            <div class="profile-field-group">
                <label for="edit-email-input">Email Address:</label>
                <input type="email" id="edit-email-input" class="profile-input" placeholder="your@example.com">
            </div>

            <div class="profile-field-group">
                <label for="edit-mobile-input">Mobile Number:</label>
                <input type="tel" id="edit-mobile-input" class="profile-input" placeholder="e.g., +91 9876543210">
            </div>

            <div class="profile-input-group">
                <label for="edit-age-input">Age:</label>
                <input type="number" id="edit-age-input" class="profile-input" placeholder="e.g., 30" min="1">
            </div>

            <div class="profile-input-group">
                <label for="edit-gender-input">Gender:</label>
                <select id="edit-gender-input" class="profile-input">
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </select>
            </div>

            <div class="profile-input-group">
                <label for="edit-about-you-input">About You (Optional):</label>
                <textarea id="edit-about-you-input" class="profile-input" rows="3" placeholder="Tell us a little about yourself..."></textarea>
            </div>

            <p>User ID: <span id="profile-user-id" class="font-bold">N/A</span></p>
            <p id="profile-message" class="profile-message" style="display: none;"></p>
        </div>

        <h2 class="text-2xl font-bold mb-4">Progress Stats</h2>
        <div class="profile-stats-grid">
            <div class="profile-stat-card">
                <span class="stat-value" id="profile-tests-attempted">0</span>
                <span>Tests Attempted</span>
            </div>
            <div class="profile-stat-card">
                <span class="stat-value" id="profile-average-score">0%</span>
                <span>Average Score</span>
            </div>
        </div>
        <div class="weak-areas-section">
            <h2 class="text-xl font-bold mb-2">Weak Areas:</h2>
            <ul id="profile-weak-areas" class="weak-areas-list">
                <li>No weak areas identified yet! Keep practicing!</li>
            </ul>
        </div>


        <div class="profile-buttons-group">
            <button id="save-profile-button" class="glass-button-base glass-button-green">Save Profile</button>
            <button id="go-to-settings-button" class="glass-button-base glass-button-default">Settings</button>
            <button id="back-to-subject-selection-from-profile" class="glass-button-base glass-button-primary">Back to Quiz Selection</button>
            <button class="logout-button-class glass-button-base glass-button-danger">Logout</button>
        </div>
    </div>

    <!-- Settings Page -->
    <div class="settings-container" id="settings-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Settings</h1>

        <div class="settings-option">
            <label for="change-password-button">Change Password</label>
            <button id="change-password-button" class="glass-button-base glass-button-primary">Change</button>
        </div>

        <div class="settings-option">
            <label for="notifications-toggle">Notifications</label>
            <input type="checkbox" id="notifications-toggle" class="settings-input" checked>
        </div>

        <div class="settings-option">
            <label for="language-select">Language</label>
            <select id="language-select" class="settings-input">
                <option value="English">English</option>
                <option value="Hindi">Hindi</option>
            </select>
        </div>

        <div class="settings-option">
            <label for="dark-mode-toggle">Dark Mode</label>
            <input type="checkbox" id="dark-mode-toggle" class="settings-input">
        </div>

        <div class="settings-option">
            <label for="help-feedback-button">Help / Feedback</label>
            <button id="help-feedback-button" class="glass-button-base glass-button-primary">Go</button>
        </div>

        <button id="back-to-profile-from-settings" class="glass-button-base glass-button-primary mt-6">Back to Profile</button>
    </div>

    <!-- Extra Features Page -->
    <div class="extra-features-container" id="extra-features-container" style="display: none;">
        <h1 class="text-3xl font-bold mb-6">Extra Features (Future Scope)</h1>

        <div class="feature-item">
            <span class="icon">🔔</span>
            Daily Quiz Notification
        </div>
        <div class="feature-item">
            <span class="icon">📌</span>
            Bookmark Difficult Questions
        </div>
        <div class="feature-item">
            <span class="icon">💬</span>
            Doubt Discussion Forum
        </div>
        <div class="feature-item">
            <span class="icon">🏆</span>
            Leaderboard (Compare with peers)
        </div>
        <div class="feature-item">
            <span class="icon">📴</span>
            Offline Mode
        </div>

        <button id="back-to-home-from-extra-features" class="glass-button-base glass-button-primary mt-6">Back to Home</button>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signOut, 
            onAuthStateChanged, 
            signInWithCustomToken,
            GoogleAuthProvider, 
            signInWithPopup,    
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            set, 
            get, 
            update, 
            query, 
            orderByChild, 
            limitToLast, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";


        // Firebase Configuration (using __firebase_config if available, otherwise fallback to provided)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyChjZ5N-1FEnejaahfpFPxIq2R7nQuTuDc",
            authDomain: "test-2378c.firebaseapp.com",
            databaseURL: "https://test-2378c-default-rtdb.asia-southeast1.firebasedatabase.app", // Corrected URL!
            projectId: "test-2378c",
            storageBucket: "test-2378c.appspot.com", // Corrected storageBucket!
            messagingSenderId: "440618434249",
            appId: "1:440618434249:web:f5c3d49edc53545a459718",
            measurementId: "G-NB1917M42Y"
        };

        // Initialize Firebase variables at a higher scope but assign within DOMContentLoaded
        let app;
        let auth;
        let db;

        let userId = null; 
        let currentUserEmail = null; 

        let allQuestionsFromDB = {}; 
        let quizQuestionsAttempted = []; // New: To store questions for solutions page

        let questions = []; 
        let currentQuestionIndex = 0;
        let timerInterval;
        const timePerQuestion = 20; 
        let questionStartTime; 
        let selectedSubjectName = ''; 
        let lastQuizSetupScreen = ''; // Global to store the ID of the screen that led to question count

        // Quiz statistics
        let correctAnswersCount = 0;
        let incorrectAnswersCount = 0;
        let questionsAttempted = 0;
        let totalTimeTaken = 0; 

        // Get references to HTML elements
        const splashScreen = document.getElementById('splash-screen'); 
        const authContainer = document.getElementById('auth-container'); 
        const authMainTitle = document.getElementById('auth-main-title');
        const authIntroText = document.getElementById('auth-intro-text');

        const showLoginButton = document.getElementById('show-login-button');
        const showSignupButton = document.getElementById('show-signup-button');
        const loginFormSection = document.getElementById('login-form-section');
        const signupFormSection = document.getElementById('signup-form-section');

        const googleLoginButton = document.getElementById('google-login-button'); 
        const anonymousLoginButton = document.getElementById('anonymous-login-button'); 
        const appleLoginButton = document.getElementById('apple-login-button'); // New Apple login button
        
        const loginEmailInput = document.getElementById('login-email-input'); 
        const loginPasswordInput = document.getElementById('login-password-input'); 
        const emailLoginButton = document.getElementById('email-login-button'); 
        const forgotPasswordButton = document.getElementById('forgot-password-button'); 
        const authErrorMessage = document.getElementById('auth-error-message'); 

        const signupFirstNameInput = document.getElementById('signup-first-name-input'); // New
        const signupLastNameInput = document.getElementById('signup-last-name-input'); // New
        const signupCountryCodeInput = document.getElementById('signup-country-code-input'); // New
        const signupPhoneInput = document.getElementById('signup-phone-input'); // New
        const signupEmailInput = document.getElementById('signup-email-input'); 
        const signupPasswordInput = document.getElementById('signup-password-input'); 
        const signupConfirmPasswordInput = document.getElementById('signup-confirm-password-input'); 
        const signupAgeInput = document.getElementById('signup-age-input'); 
        const signupGenderInput = document.getElementById('signup-gender-input'); 
        const signupAboutYouInput = document.getElementById('signup-about-you-input'); 
        const emailSignupButton = document.getElementById('email-signup-button'); 
        const googleSignupButton = document.getElementById('google-signup-button'); // New
        const appleSignupButton = document.getElementById('apple-signup-button'); // New
        const authErrorMessageSignup = document.getElementById('auth-error-message-signup'); // New for signup errors

        const homeScreenContainer = document.getElementById('home-screen-container'); 
        const welcomeUserName = document.getElementById('welcome-user-name'); 
        const cardGeneralAwareness = document.getElementById('card-general-awareness'); 
        const cardReasoning = document.getElementById('card-reasoning'); 
        const cardQuantitativeAptitude = document.getElementById('card-quantitative-aptitude'); 
        const cardEnglishLanguage = document.getElementById('card-english-language'); 
        const cardComputerKnowledge = document.getElementById('card-computer-knowledge'); // New
        const cardGeneralStudies = document.getElementById('card-general-studies'); // New
        const cardCurrentAffairs = document.getElementById('card-current-affairs'); // New
        const cardMockTestZone = document.getElementById('card-mock-test-zone'); // New
        const extraFeaturesButton = document.getElementById('extra-features-button'); 

        // New elements for global header
        const mainHeader = document.getElementById('main-header');
        const headerUserDisplayName = document.getElementById('header-user-display-name');
        const headerProfilePhoto = document.getElementById('header-profile-photo');
        
        let logoutButtons; 

        const subjectSelectionContainer = document.getElementById('subject-selection-container');
        const gaSubjectsContainer = document.getElementById('ga-subjects-container'); // New GA subjects container
        const reasoningSubjectsContainer = document.getElementById('reasoning-subjects-container'); // New
        const quantitativeAptitudeSubjectsContainer = document.getElementById('quantitative-aptitude-subjects-container'); // New
        const englishLanguageSubjectsContainer = document.getElementById('english-language-subjects-container'); // New
        const computerKnowledgeSubjectsContainer = document.getElementById('computer-knowledge-subjects-container'); // New
        const generalStudiesSubjectsContainer = document.getElementById('general-studies-subjects-container'); // New
        const currentAffairsSubjectsContainer = document.getElementById('current-affairs-subjects-container'); // New
        const mockTestZoneSubjectsContainer = document.getElementById('mock-test-zone-subjects-container'); // New
        const questionCountContainer = document.getElementById('question-count-container');
        const quizContainer = document.getElementById('quiz-container');
        const userDataContainer = document.getElementById('user-data-container'); 
        const userProfileContainer = document.getElementById('user-profile-container'); 
        const resultSummaryContainer = document.getElementById('result-summary-container'); 
        const solutionExplanationContainer = document.getElementById('solution-explanation-container'); 
        const settingsContainer = document.getElementById('settings-container'); 
        const extraFeaturesContainer = document.getElementById('extra-features-container'); 

        const economyButton = document.getElementById('economy-button');
        const politicsButton = document.getElementById('politics-button');
        const historyButton = document.getElementById('history-button');
        const geographyButton = document.getElementById('geography-button');
        const viewActivityButton = document.getElementById('view-activity-button'); 
        const viewProfileButton = document.getElementById('view-profile-button'); 
        const backToQuizSelectionButton = document.getElementById('back-to-quiz-selection'); 
        const backToSubjectSelectionFromProfileButton = document.getElementById('back-to-subject-selection-from-profile'); 

        // New GA sub-subject buttons
        const gaStaticGkButton = document.getElementById('ga-static-gk-button');
        const gaCurrentAffairsButton = document.getElementById('ga-current-affairs-button');
        const gaPolityButton = document.getElementById('ga-polity-button');
        const gaHistoryButton = document.getElementById('ga-history-button');
        const gaGeographyButton = document.getElementById('ga-geography-button');
        const gaScienceButton = document.getElementById('ga-science-button');
        const gaEconomyButton = document.getElementById('ga-economy-button');
        const backToHomeFromGaSubjectsButton = document.getElementById('back-to-home-from-ga-subjects');

        // New Reasoning sub-subject buttons
        const reasoningAnalogyButton = document.getElementById('reasoning-analogy-button');
        const reasoningSeriesButton = document.getElementById('reasoning-series-button');
        const reasoningPuzzlesButton = document.getElementById('reasoning-puzzles-button');
        const reasoningCodingDecodingButton = document.getElementById('reasoning-coding-decoding-button');
        const reasoningBloodRelationsButton = document.getElementById('reasoning-blood-relations-button');
        const backToHomeFromReasoningSubjectsButton = document.getElementById('back-to-home-from-reasoning-subjects');

        // New Quantitative Aptitude sub-subject buttons
        const quantArithmeticButton = document.getElementById('quant-arithmetic-button');
        const quantAlgebraButton = document.getElementById('quant-algebra-button');
        const quantGeometryButton = document.getElementById('quant-geometry-button');
        const quantMensurationButton = document.getElementById('quant-mensuration-button');
        const quantTrigonometryButton = document.getElementById('quant-trigonometry-button');
        const quantDiButton = document.getElementById('quant-di-button');
        const backToHomeFromQuantSubjectsButton = document.getElementById('back-to-home-from-quant-subjects');

        // New English Language sub-subject buttons
        const englishVocabularyButton = document.getElementById('english-vocabulary-button');
        const englishGrammarButton = document.getElementById('english-grammar-button'); 
        const englishReadingComprehensionButton = document.getElementById('english-reading-comprehension-button');
        const englishClozeTestButton = document.getElementById('english-cloze-test-button');
        const englishSpotErrorButton = document.getElementById('english-spot-error-button');
        const backToHomeFromEnglishSubjectsButton = document.getElementById('back-to-home-from-english-subjects');

        // New Computer Knowledge sub-subject buttons
        const computerBasicsButton = document.getElementById('computer-basics-button');
        const computerInternetButton = document.getElementById('computer-internet-button');
        const computerMsOfficeButton = document.getElementById('computer-ms-office-button');
        const computerAbbreviationsButton = document.getElementById('computer-abbreviations-button');
        const backToHomeFromComputerSubjectsButton = document.getElementById('back-to-home-from-computer-subjects');

        // New General Studies sub-subject buttons
        const gsEngineeringButton = document.getElementById('gs-engineering-button');
        const gsAdvancedEconomyButton = document.getElementById('gs-advanced-economy-button');
        const gsAdvancedPolityButton = document.getElementById('gs-advanced-polity-button');
        const backToHomeFromGeneralStudiesSubjectsButton = document.getElementById('back-to-home-from-general-studies-subjects');

        // New Current Affairs Sub-subject buttons
        const caDailyQuizzesButton = document.getElementById('ca-daily-quizzes-button');
        const caBudgetButton = document.getElementById('ca-budget-button');
        const caGovtSchemesButton = document.getElementById('ca-govt-schemes-button');
        const caMonthlyPdfsButton = document.getElementById('ca-monthly-pdfs-button');
        const backToHomeFromCurrentAffairsSubjectsButton = document.getElementById('back-to-home-from-current-affairs-subjects');

        // Mock Test Zone Sub-subject buttons
        const mtzFullLengthMocksButton = document.getElementById('mtz-full-length-mocks-button');
        const mtzSectionalTestsButton = document.getElementById('mtz-sectional-tests-button');
        const mtzTierWiseTestsButton = document.getElementById('mtz-tier-wise-tests-button');
        const backToHomeFromMockTestZoneSubjectsButton = document.getElementById('back-to-home-from-mock-test-zone-subjects');


        const selectedSubjectTitle = document.getElementById('selected-subject-title');
        const totalAvailableQuestionsSpan = document.getElementById('total-available-questions');
        const numQuestionsInput = document.getElementById('num-questions');
        const questionCountError = document.getElementById('question-count-error');
        const startPracticeButton = document.getElementById('start-practice-button');
        const backToSubjectSelectionFromQuestionCountButton = document.getElementById('back-to-subject-selection-from-question-count'); // New

        const quizSubjectTitle = document.getElementById('quiz-subject-title');
        const questionDisplay = document.getElementById('question-display');
        const optionsContainer = document.getElementById('options-container');
        const timerDisplay = document.getElementById('timer-display');
        const feedbackArea = document.getElementById('feedback-area');
        const correctAnswerArea = document.getElementById('correct-answer-area');
        // New element for automatic Gemini explanation
        const autoGeminiExplanationArea = document.getElementById('auto-gemini-explanation-area');

        const nextButton = document.getElementById('next-button');
        const showResultButton = document.getElementById('show-result-button');
        const backToQuestionCountFromQuizButton = document.getElementById('back-to-question-count-from-quiz'); // New
        
        const currentStreakDisplay = document.getElementById('current-streak-display'); 
        const pastAttemptsList = document.getElementById('past-attempts-list'); 

        const profilePhoto = document.getElementById('profile-photo'); 
        const profileUserId = document.getElementById('profile-user-id');

        // Elements for editable profile (on My Profile page)
        const editDisplayNameInput = document.getElementById('edit-display-name-input');
        const editEmailInput = document.getElementById('edit-email-input');
        const editMobileInput = document.getElementById('edit-mobile-input'); 
        const editAgeInput = document.getElementById('edit-age-input'); 
        const editGenderInput = document.getElementById('edit-gender-input'); 
        const editAboutYouInput = document.getElementById('edit-about-you-input'); 
        const saveProfileButton = document.getElementById('save-profile-button');
        const goToSettingsButton = document.getElementById('go-to-settings-button'); 
        const profileMessage = document.getElementById('profile-message');

        // Elements for Result Summary Page
        const resultSubject = document.getElementById('result-subject');
        const resultTotalQuestions = document.getElementById('result-total-questions');
        const resultCorrectCount = document.getElementById('result-correct-count');
        const resultIncorrectCount = document.getElementById('result-incorrect-count');
        const resultTimeTaken = document.getElementById('result-time-taken');
        const resultScorePercentage = document.getElementById('result-score-percentage');
        const viewSolutionsButton = document.getElementById('view-solutions-button');
        const retryTestButton = document.getElementById('retry-test-button');
        const shareScoreButton = document.getElementById('share-score-button');
        const backToQuestionCountFromResultButton = document.getElementById('back-to-question-count-from-result'); // New

        // Elements for Solution/Explanation Page
        const solutionsList = document.getElementById('solutions-list'); 
        const backToResultsButton = document.getElementById('back-to-results-button'); 

        // New elements for Profile Page Stats
        const profileTestsAttempted = document.getElementById('profile-tests-attempted');
        const profileAverageScore = document.getElementById('profile-average-score');
        const profileWeakAreas = document.getElementById('profile-weak-areas');

        // New elements for Settings Page
        const changePasswordButton = document.getElementById('change-password-button');
        const notificationsToggle = document.getElementById('notifications-toggle');
        const languageSelect = document.getElementById('language-select');
        const helpFeedbackButton = document.getElementById('help-feedback-button');
        const backToProfileFromSettingsButton = document.getElementById('back-to-profile-from-settings');

        // New elements for Extra Features Page
        const backToHomeFromExtraFeaturesButton = document.getElementById('back-to-home-from-extra-features');


        /**
         * Toggles the visibility between the login and signup forms.
         * @param {string} formToShow - 'login' or 'signup'
         */
        function toggleAuthForms(formToShow) {
            if (formToShow === 'login') {
                loginFormSection.classList.add('active');
                signupFormSection.classList.remove('active');
                showLoginButton.classList.add('active');
                showSignupButton.classList.remove('active');
                authMainTitle.textContent = "Welcome Back!";
                authIntroText.textContent = "Please sign in to continue.";
                authErrorMessageSignup.style.display = 'none'; // Clear signup errors
            } else { // formToShow === 'signup'
                loginFormSection.classList.remove('active');
                signupFormSection.classList.add('active');
                showLoginButton.classList.remove('active');
                showSignupButton.classList.add('active');
                authMainTitle.textContent = "Join the Quiz App!";
                authIntroText.textContent = "Create your account to get started.";
                authErrorMessage.style.display = 'none'; // Clear login errors
            }
            authErrorMessage.style.display = 'none'; // Clear errors when switching
        }


        /**
         * Fisher-Yates (Knuth) shuffle algorithm for array randomization.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array;
            }

        /**
         * Formats a timestamp (milliseconds since epoch) into a readable date string.
         * @param {number} timestamp - Timestamp in milliseconds.
         * @returns {string} Formatted date string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) {
                return 'N/A';
            }
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Checks if a date is yesterday compared to today.
         * @param {Date} someDate - The date to check.
         * @param {Date} today - The current date.
         * @returns {boolean} True if someDate is yesterday, false otherwise.
         */
        function isYesterday(someDate, today) {
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            return someDate.getFullYear() === yesterday.getFullYear() &&
                   someDate.getMonth() === yesterday.getMonth() &&
                   someDate.getDate() === yesterday.getDate();
        }

        /**
         * Fetches all quiz questions from the Realtime Database and stores them.
         */
        async function fetchAllQuestionsFromDB() {
            console.log("Fetching all questions from Realtime Database...");
            const questionsRef = ref(db, 'questions'); // Assuming questions are stored under a 'questions' node
            try {
                const snapshot = await get(questionsRef);
                if (snapshot.exists()) {
                    const questionsData = snapshot.val();
                    allQuestionsFromDB = {}; // Reset
                    // Group questions by subject
                    Object.keys(questionsData).forEach(key => {
                        const question = questionsData[key];
                        // Ensure question.subject exists and is a string
                        if (question.subject && typeof question.subject === 'string') {
                            if (!allQuestionsFromDB[question.subject]) {
                                allQuestionsFromDB[question.subject] = [];
                            }
                            allQuestionsFromDB[question.subject].push(question);
                        } else {
                            console.warn(`Question with key ${key} has no subject or invalid subject type. Skipping.`, question);
                        }
                    });
                    console.log("Questions fetched and grouped:", allQuestionsFromDB);
                } else {
                    console.warn("No questions found in Realtime Database under '/questions'. Please ensure data is present and correctly structured.");
                    // Optionally, display a message to the user or load default questions
                }
            } catch (error) {
                console.error("Error fetching questions from Realtime Database:", error);
                // This error often means a permission issue. Ensure your Realtime Database rules allow reads for the 'questions' node.
                // Example rule: { "rules": { "questions": { ".read": true, ".write": false } } }
                // Also, check if the 'questions' node actually exists in your Firebase Realtime Database.
            }
        }

        /**
         * Updates the UI based on the current authentication state.
         * Fetches user data (like streak) if logged in.
         * @param {firebase.User} user - The authenticated Firebase user object, or null if logged out.
         */
        async function updateUI(user) {
            console.log("UI: updateUI called with user:", user ? user.uid : "null");
            if (user) {
                userId = user.uid;
                // Determine user's display name for UI
                let userDisplayName = user.email || 'Anonymous User';
                if (user.displayName) {
                    userDisplayName = user.displayName;
                } else if (user.email) {
                    userDisplayName = user.email; // Fallback to email if display name not available
                } else if (user.isAnonymous) {
                    userDisplayName = 'Anonymous User';
                }

                // Update global header elements
                headerUserDisplayName.textContent = userDisplayName.split(' ')[0]; // Show first name
                headerProfilePhoto.src = user.photoURL || "https://placehold.co/40x40/cccccc/333333?text=👤";
                mainHeader.style.display = 'flex'; // Show the header when logged in

                welcomeUserName.textContent = userDisplayName.split(' ')[0]; // Show first name or full if no space

                // Hide splash screen and auth container, show home screen
                console.log("UI: Setting main content display timeout.");
                setTimeout(() => {
                    console.log("UI: Main content display timeout finished. Hiding splash, showing home.");
                    splashScreen.style.display = 'none';
                    authContainer.style.display = 'none'; 
                    homeScreenContainer.style.display = 'flex'; // Show home screen
                    subjectSelectionContainer.style.display = 'none';
                    gaSubjectsContainer.style.display = 'none'; // Ensure GA subjects container is hidden
                    reasoningSubjectsContainer.style.display = 'none'; // New
                    quantitativeAptitudeSubjectsContainer.style.display = 'none'; // New
                    englishLanguageSubjectsContainer.style.display = 'none'; // New
                    computerKnowledgeSubjectsContainer.style.display = 'none'; // New
                    generalStudiesSubjectsContainer.style.display = 'none'; // New
                    currentAffairsSubjectsContainer.style.display = 'none'; // New
                    mockTestZoneSubjectsContainer.style.display = 'none'; // New
                    questionCountContainer.style.display = 'none';
                    quizContainer.style.display = 'none';
                    userDataContainer.style.display = 'none'; 
                    userProfileContainer.style.display = 'none'; 
                    resultSummaryContainer.style.display = 'none'; 
                    solutionExplanationContainer.style.display = 'none'; 
                    settingsContainer.style.display = 'none'; 
                    extraFeaturesContainer.style.display = 'none'; 
                    authErrorMessage.style.display = 'none'; 
                    authErrorMessageSignup.style.display = 'none'; // Also hide signup error
                }, 500); // Match this to the transition duration in CSS

                // Fetch and display user streak from Realtime Database
                if (userId) {
                    const userRef = ref(db, `users/${userId}`);
                    try {
                        const snapshot = await get(userRef);
                        let userData = {};
                        if (snapshot.exists()) {
                            userData = snapshot.val();
                            currentStreakDisplay.textContent = userData.currentStreak || 0;
                            console.log("UI: Fetched user streak:", userData.currentStreak);
                        } else {
                            // If user data doesn't exist, initialize with defaults
                            userData.currentStreak = 0;
                            userData.lastQuizDate = null;
                            currentStreakDisplay.textContent = 0;
                            console.log("UI: Initialized new user data in Realtime DB with default streak.");
                        }

                        // Update user profile data in Realtime DB (display name, email, photoURL)
                        // This ensures basic profile info is stored for all login types
                        const profileUpdates = {};
                        if (user.displayName && userData.displayName !== user.displayName) {
                            profileUpdates.displayName = user.displayName;
                        }
                        if (user.email && userData.email !== user.email) {
                            profileUpdates.email = user.email;
                        }
                        // Add photoURL if available (e.g., from Google login)
                        if (user.photoURL && userData.photoURL !== user.photoURL) {
                            profileUpdates.photoURL = user.photoURL;
                        }
                        
                        if (Object.keys(profileUpdates).length > 0) {
                            await update(userRef, profileUpdates);
                            console.log("UI: User profile data updated in Realtime DB:", profileUpdates);
                        }

                    } catch (error) {
                        console.error("UI: Error fetching/setting user streak or profile from Realtime DB:", error);
                        currentStreakDisplay.textContent = "Error";
                    }
                }

            } else {
                userId = null;
                currentUserEmail = null;
                console.log("UI: User logged out, showing login screen.");
                mainHeader.style.display = 'none'; // Hide the header when logged out
                splashScreen.classList.add('hidden'); // Ensure splash screen fades out
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    authContainer.style.display = 'flex'; 
                    homeScreenContainer.style.display = 'none'; 
                    subjectSelectionContainer.style.display = 'none';
                    gaSubjectsContainer.style.display = 'none'; // Ensure GA subjects container is hidden
                    reasoningSubjectsContainer.style.display = 'none'; // New
                    quantitativeAptitudeSubjectsContainer.style.display = 'none'; // New
                    englishLanguageSubjectsContainer.style.display = 'none'; // New
                    computerKnowledgeSubjectsContainer.style.display = 'none'; // New
                    generalStudiesSubjectsContainer.style.display = 'none'; // New
                    currentAffairsSubjectsContainer.style.display = 'none'; // New
                    mockTestZoneSubjectsContainer.style.display = 'none'; // New
                    questionCountContainer.style.display = 'none';
                    quizContainer.style.display = 'none';
                    userDataContainer.style.display = 'none'; 
                    userProfileContainer.style.display = 'none'; 
                    resultSummaryContainer.style.display = 'none'; 
                    solutionExplanationContainer.style.display = 'none'; 
                    settingsContainer.style.display = 'none'; 
                    extraFeaturesContainer.style.display = 'none'; 
                    // Clear input fields on logout
                    loginEmailInput.value = '';
                    loginPasswordInput.value = '';
                    signupFirstNameInput.value = ''; // Clear new fields
                    signupLastNameInput.value = ''; // Clear new fields
                    signupPhoneInput.value = ''; // Clear new fields
                    signupEmailInput.value = '';
                    signupPasswordInput.value = '';
                    signupConfirmPasswordInput.value = '';
                    signupAgeInput.value = '';
                    signupGenderInput.value = '';
                    signupAboutYouInput.value = '';
                    authErrorMessage.textContent = '';
                    authErrorMessage.style.display = 'none';
                    authErrorMessageSignup.textContent = ''; // Clear signup error
                    authErrorMessageSignup.style.display = 'none'; // Hide signup error
                    toggleAuthForms('login'); // Default to login form on logout
                }, 500); // Match this to the transition duration in CSS
            }
        }

        /**
         * Displays an authentication error message.
         * @param {string} message - The error message to display.
         * @param {HTMLElement} errorElement - The specific error message element to update.
         */
        function showAuthError(message, errorElement = authErrorMessage) {
            // Specific message for unauthorized-domain error
            if (message.includes("auth/unauthorized-domain")) {
                message += " Please add your app's domain (e.g., localhost or your Vercel URL) to Firebase Console > Authentication > Settings > Authorized domains.";
            }
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            errorElement.style.color = '#ef4444'; 
            console.error("Auth Error:", message); 
        }

        /**
         * Handles anonymous login.
         */
        async function loginAnonymously() {
            console.log("AUTH: Attempting anonymous login...");
            try {
                await signInAnonymously(auth);
                console.log("AUTH: Signed in anonymously successfully.");
            } catch (error) {
                console.error("AUTH: Error signing in anonymously:", error);
                showAuthError(`Anonymous login failed: ${error.message}`);
            }
        }

        /**
         * Handles Google login.
         */
        async function signInWithGoogle() {
            console.log("AUTH: Attempting Google login...");
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                console.log("AUTH: Signed in with Google successfully.");
            } catch (error) {
                console.error("AUTH: Error signing in with Google:", error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showAuthError("Google login popup closed by user.");
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showAuthError("Google login popup already open or request cancelled.");
                } else if (error.code === 'auth/unauthorized-domain') {
                    showAuthError(`Google login failed: ${error.message}`);
                }
                else {
                    showAuthError(`Google login failed: ${error.message}`);
                }
            }
        }

        /**
         * Handles Apple login (placeholder).
         */
        async function signInWithApple() {
            console.log("AUTH: Apple login functionality coming soon!");
            showAuthError("Apple login is not yet implemented.", authErrorMessage);
        }

        /**
         * Handles email/password sign up.
         */
        async function signUpWithEmailPassword() {
            const firstName = signupFirstNameInput.value.trim();
            const lastName = signupLastNameInput.value.trim();
            const email = signupEmailInput.value.trim();
            const countryCode = signupCountryCodeInput.value;
            const phoneNumber = signupPhoneInput.value.trim();
            const password = signupPasswordInput.value;
            const confirmPassword = signupConfirmPasswordInput.value;
            const age = signupAgeInput.value.trim();
            const gender = signupGenderInput.value.trim();
            const aboutYou = signupAboutYouInput.value.trim();

            console.log(`AUTH: Attempting email signup for: ${email}`);
            if (!firstName || !lastName || !email || !password) {
                showAuthError("Please enter First Name, Last Name, Email, and Password to register.", authErrorMessageSignup);
                return;
            }
            if (password.length < 6) {
                showAuthError("Password should be at least 6 characters.", authErrorMessageSignup);
                return;
            }
            if (password !== confirmPassword) {
                showAuthError("Passwords do not match.", authErrorMessageSignup);
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("AUTH: Signed up with email/password successfully. User:", user.uid);

                const fullName = `${firstName} ${lastName}`;
                // Update Firebase Auth profile with display name
                await updateProfile(user, { displayName: fullName });

                // Save additional profile data to Realtime Database
                const userRef = ref(db, `users/${user.uid}`);
                await set(userRef, {
                    displayName: fullName,
                    firstName: firstName, // Store first name separately
                    lastName: lastName,   // Store last name separately
                    email: email,
                    phoneNumber: phoneNumber ? `${countryCode}${phoneNumber}` : null, // Store combined phone number
                    age: age || null,
                    gender: gender || null,
                    aboutYou: aboutYou || null,
                    createdAt: serverTimestamp(),
                    currentStreak: 0,
                    lastQuizDate: null
                });
                console.log("AUTH: Additional user profile data saved to Realtime Database.");

            } catch (error) {
                console.error("AUTH: Error signing up with email/password:", error);
                showAuthError(`Registration failed: ${error.message}`, authErrorMessageSignup);
            }
        }

        /**
         * Handles email/password login.
         */
        async function signInWithEmailPassword() {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value;
            console.log(`AUTH: Attempting email login for: ${email}`);
            if (!email || !password) {
                showAuthError("Please enter both email and password.");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("AUTH: Signed in with email/password successfully.");
            } catch (error) {
                console.error("AUTH: Error signing in with email/password:", error);
                showAuthError(`Login failed: ${error.message}`);
            }
        }

        /**
         * Handles sending a password reset email.
         */
        async function handleForgotPassword() {
            const email = loginEmailInput.value.trim(); 
            console.log(`AUTH: Attempting to send password reset email to: ${email}`);
            if (!email) {
                showAuthError("Please enter your email address to reset your password.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                authErrorMessage.textContent = "Password reset email sent! Please check your inbox (and spam folder).";
                authErrorMessage.style.color = '#059669'; 
                authErrorMessage.style.display = 'block';
                console.log("AUTH: Password reset email sent successfully.");
            } catch (error) {
                console.error("AUTH: Error sending password reset email:", error);
                showAuthError(`Failed to send password reset email: ${error.message}`);
            }
        }

        /**
         * Handles user logout.
         */
        async function logoutUser() {
            console.log("AUTH: Attempting to log out user...");
            try {
                await signOut(auth);
                console.log("AUTH: User signed out successfully.");
            } catch (error) {
                    console.error("AUTH: Error signing out:", error);
                    // Do not show an error message if the user is already signed out (e.g., due to token expiry)
                    // This prevents an error message from appearing if the user session has already ended naturally.
                    if (error.code !== 'auth/no-current-user') {
                        showAuthError(`Logout failed: ${error.message}`);
                    }
                }
        }

        /**
         * Hides all main content containers.
         */
        function hideAllContainers() {
            authContainer.style.display = 'none';
            homeScreenContainer.style.display = 'none';
            subjectSelectionContainer.style.display = 'none';
            gaSubjectsContainer.style.display = 'none';
            reasoningSubjectsContainer.style.display = 'none';
            quantitativeAptitudeSubjectsContainer.style.display = 'none';
            englishLanguageSubjectsContainer.style.display = 'none';
            computerKnowledgeSubjectsContainer.style.display = 'none';
            generalStudiesSubjectsContainer.style.display = 'none';
            currentAffairsSubjectsContainer.style.display = 'none';
            mockTestZoneSubjectsContainer.style.display = 'none';
            questionCountContainer.style.display = 'none';
            quizContainer.style.display = 'none';
            userDataContainer.style.display = 'none';
            userProfileContainer.style.display = 'none';
            resultSummaryContainer.style.display = 'none';
            solutionExplanationContainer.style.display = 'none';
            settingsContainer.style.display = 'none';
            extraFeaturesContainer.style.display = 'none';
            splashScreen.style.display = 'none';
        }

        /**
         * Initializes the quiz by displaying the splash screen first.
         * After a delay, it transitions to the appropriate UI based on auth state.
         */
        async function initQuiz() { 
            console.log("INIT: initQuiz called."); // Added log
            hideAllContainers(); // Hide all containers
            splashScreen.style.display = 'flex'; // Show splash screen initially
            splashScreen.classList.remove('hidden'); // Ensure it's not hidden from previous runs

            console.log("INIT: Fetching all questions..."); // Added log
            await fetchAllQuestionsFromDB();

            console.log("INIT: Setting splash screen timeout..."); // Added log
            setTimeout(() => {
                console.log("INIT: Splash screen timeout finished. Calling updateUI."); // Added log
                updateUI(auth.currentUser);
            }, 3000); // Changed from 1000 to 3000 for 3 seconds
        }


        /**
         * Prepares the quiz by filtering and shuffling questions, then shows the question count selection.
         * @param {string} subject - The selected subject (e.g., "Economy", "Politics", "History", "Geography", "Static GK", "Algebra", etc.).
         * @param {string} originScreenId - The ID of the screen that triggered this function (e.g., 'ga-subjects-container').
         */
        function prepareQuiz(subject, originScreenId) {
            console.log(`QUIZ_PREP: Preparing quiz for subject: ${subject} from ${originScreenId}`);
            selectedSubjectName = subject; 
            lastQuizSetupScreen = originScreenId; // Store the origin screen ID
            
            let subjectQuestions = [];

            // Special handling for "Full Mock Test" or "Mock Test Zone" if it combines all questions
            if (subject === "Full Length Mocks") { // Assuming "Full Length Mocks" is the combined one
                Object.values(allQuestionsFromDB).forEach(qArray => {
                    subjectQuestions = subjectQuestions.concat(qArray);
                });
                console.log(`QUIZ_PREP: Full Length Mocks: Combined ${subjectQuestions.length} questions from all subjects.`);
            } else if (allQuestionsFromDB[subject]) {
                subjectQuestions = [...allQuestionsFromDB[subject]];
            } else {
                console.warn(`QUIZ_PREP: No questions available for subject: ${subject}. This might be a missing subject in your database.`);
            }

            if (!subjectQuestions || subjectQuestions.length === 0) {
                console.warn(`QUIZ_PREP: No questions available for subject: ${subject}`);
                questionCountError.textContent = `No questions found for ${subject}. This section is coming soon!`;
                questionCountError.style.display = 'block';
                startPracticeButton.disabled = true; 
                
                hideAllContainers(); // Hide all containers
                questionCountContainer.style.display = 'flex'; 

                selectedSubjectTitle.textContent = subject;
                totalAvailableQuestionsSpan.textContent = 0; 
                numQuestionsInput.value = 0;
                numQuestionsInput.max = 0;
                return; 
            }

            questions = shuffleArray([...subjectQuestions]); 

            hideAllContainers(); // Hide all containers
            questionCountContainer.style.display = 'flex';

            selectedSubjectTitle.textContent = subject;
            totalAvailableQuestionsSpan.textContent = questions.length;
            numQuestionsInput.value = Math.min(10, questions.length); 
            numQuestionsInput.max = questions.length; 
            questionCountError.style.display = 'none'; 
            startPracticeButton.disabled = false; 
            console.log(`QUIZ_PREP: Total questions available for ${subject}: ${questions.length}`);
        }

        /**
         * Starts the actual quiz after the user has selected the number of questions.
         */
        function startActualQuiz() {
            const desiredCount = parseInt(numQuestionsInput.value, 10);
            const totalAvailable = questions.length;

            if (isNaN(desiredCount) || desiredCount <= 0 || desiredCount > totalAvailable) {
                questionCountError.textContent = `Please enter a number between 1 and ${totalAvailable}.`;
                questionCountError.style.display = 'block';
                return;
            }

            // Slice the questions array to the desired count
            questions = questions.slice(0, desiredCount);
            quizQuestionsAttempted = [...questions]; 
            console.log(`QUIZ_START: Starting quiz with ${questions.length} questions.`);

            // Reset quiz stats
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            incorrectAnswersCount = 0;
            questionsAttempted = 0;
            totalTimeTaken = 0;

            // Update quiz title based on selected subject
            quizSubjectTitle.textContent = `${selectedSubjectName} Practice - Set 1`;
            
            hideAllContainers(); // Hide all containers
            quizContainer.style.display = 'flex';

            displayQuestion();
        }

        /**
         * Displays the current question and its options, and starts the countdown timer.
         */
        function displayQuestion() {
            console.log(`QUIZ: Displaying question ${currentQuestionIndex + 1}/${questions.length}`);
            // Clear previous feedback and options
            optionsContainer.innerHTML = '';
            feedbackArea.textContent = '';
            correctAnswerArea.textContent = '';
            autoGeminiExplanationArea.style.display = 'none'; // Hide auto Gemini explanation
            autoGeminiExplanationArea.innerHTML = ''; // Clear its content
            nextButton.disabled = true; 

            if (currentQuestionIndex < questions.length) {
                const questionData = questions[currentQuestionIndex];
                questionDisplay.textContent = `${currentQuestionIndex + 1}. ${questionData.question}`;
                timerDisplay.textContent = timePerQuestion; 
                questionStartTime = new Date().getTime(); 

                // Randomize the order of options for the current question
                const shuffledOptions = shuffleArray([...questionData.options]); 

                // Create option buttons
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add('glass-button-base', 'glass-button-default'); /* Apply new button styles */
                    button.addEventListener('click', () => answerQuestion(option, questionData.answer, button));
                    optionsContainer.appendChild(button);
                });

                startCountdown();
            } else {
                // Quiz finished (all questions attempted naturally)
                console.log("QUIZ: All questions answered, ending quiz naturally.");
                endQuiz();
            }
        }

        /**
         * Starts the 20-second countdown for the current question.
         */
        function startCountdown() {
            let timeLeft = timePerQuestion;
            timerDisplay.textContent = timeLeft;
            console.log(`TIMER: Timer started for question ${currentQuestionIndex + 1}, time left: ${timeLeft}`);

            // Clear any existing interval to prevent multiple timers running
            if (timerInterval) {
                clearInterval(timerInterval);
                console.log("TIMER: Previous timer cleared.");
            }

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Time's Up!";
                    console.log("TIMER: Time's Up for current question.");

                    // If the user hasn't selected an answer when time runs out,
                    // mark it as incorrect and attempted.
                    if (nextButton.disabled) {
                        questionsAttempted++;
                        incorrectAnswersCount++;
                        console.log("QUIZ: Time ran out, no answer selected. Marked as incorrect.");
                    }
                    const currentQuestion = questions[currentQuestionIndex];
                    const timeElapsed = Math.floor((new Date().getTime() - questionStartTime) / 1000);
                    totalTimeTaken += timeElapsed; 

                    showAnswer(currentQuestion.answer, null); 
                    disableOptions(); 
                    nextButton.disabled = false; 
                    console.log("QUIZ: Next button enabled (time out).");
                }
            }, 1000); 
        }

        /**
         * Handles the user's answer selection.
         * @param {string} selectedOption - The option selected by the user.
         * @param {string} correctAnswer - The correct answer for the current question.
         * @param {HTMLButtonElement} selectedButton - The button element that was clicked.
         */
        async function answerQuestion(selectedOption, correctAnswer, selectedButton) { // Made async
            console.log(`QUIZ: Answer selected: ${selectedOption}`);
            clearInterval(timerInterval); 
            disableOptions(); 

            questionsAttempted++;
            const timeElapsed = Math.floor((new Date().getTime() - questionStartTime) / 1000);
            totalTimeTaken += timeElapsed;
            console.log(`QUIZ: Time taken for question: ${timeElapsed}s`);


            if (selectedOption === correctAnswer) {
                feedbackArea.textContent = "✅ Correct!";
                feedbackArea.style.color = '#059669'; 
                if (selectedButton) {
                    selectedButton.classList.add('correct');
                }
                correctAnswersCount++;
                console.log("QUIZ: Answer: Correct!");
            } else {
                feedbackArea.textContent = "❌ Incorrect.";
                feedbackArea.style.color = '#ef4444'; 
                if (selectedButton) {
                    selectedButton.classList.add('incorrect');
                }
                incorrectAnswersCount++;
                console.log("QUIZ: Answer: Incorrect!");

                // Automatically get Gemini explanation for incorrect answers
                autoGeminiExplanationArea.style.display = 'block';
                autoGeminiExplanationArea.innerHTML = '<div class="spinner"></div><p class="text-center text-gray-400">Generating explanation with Gemini...</p>';
                console.log("GEMINI: Requesting explanation for incorrect answer...");

                try {
                    const currentQuestion = questions[currentQuestionIndex];
                    const geminiExp = await getGeminiExplanation(
                        currentQuestion.question,
                        currentQuestion.answer,
                        currentQuestion.explanation || ''
                    );
                    autoGeminiExplanationArea.textContent = geminiExp;
                    console.log("GEMINI: Explanation received and displayed.");
                } catch (error) {
                    autoGeminiExplanationArea.textContent = `Error getting explanation: ${error.message}`;
                    autoGeminiExplanationArea.style.color = '#ef4444';
                    console.error("GEMINI: Error getting explanation:", error);
                }
            }
            showAnswer(correctAnswer, selectedButton);
            nextButton.disabled = false; 
            console.log("QUIZ: Next button enabled (answer selected).");
        }

        /**
         * Displays the correct answer and highlights the correct option.
         * @param {string} correctAnswer - The correct answer to display.
         * @param {HTMLButtonElement | null} selectedButton - The button selected by the user, or null if time ran out.
         */
        function showAnswer(correctAnswer, selectedButton) {
            correctAnswerArea.textContent = `Correct Answer: ${correctAnswer}`;
            const optionButtons = optionsContainer.querySelectorAll('.glass-button-base'); /* Use new class */
            optionButtons.forEach(button => {
                if (button.textContent === correctAnswer) {
                    // Only add 'correct' class if it wasn't already marked 'incorrect' by the user
                    if (!button.classList.contains('incorrect')) {
                        button.classList.add('correct');
                    }
                }
            });
        }

        /**
         * Disables all option buttons to prevent further selection.
         */
        function disableOptions() {
            const optionButtons = optionsContainer.querySelectorAll('.glass-button-base'); /* Use new class */
            optionButtons.forEach(button => {
                button.disabled = true;
            });
        }

        /**
         * Ends the quiz and displays the summary statistics.
         * Also attempts to save the quiz results to Realtime Database and update streak.
         */
        async function endQuiz() {
            console.log("QUIZ_END: Ending quiz and showing summary.");
            clearInterval(timerInterval); 
            hideAllContainers(); // Hide all containers
            resultSummaryContainer.style.display = 'flex';

            // Calculate score percentage
            const scorePercentage = questionsAttempted > 0 ? ((correctAnswersCount / questionsAttempted) * 100).toFixed(2) : 0;

            // Populate result summary details
            resultSubject.textContent = selectedSubjectName;
            resultTotalQuestions.textContent = questionsAttempted;
            resultCorrectCount.textContent = correctAnswersCount;
            resultIncorrectCount.textContent = incorrectAnswersCount;
            resultTimeTaken.textContent = totalTimeTaken;
            resultScorePercentage.textContent = `${scorePercentage}%`;

            // Save quiz results to Realtime Database and update streak if a user is logged in
            if (auth.currentUser && auth.currentUser.uid) {
                const currentUserId = auth.currentUser.uid;
                const userRef = ref(db, `users/${currentUserId}`);
                const quizAttemptsRef = ref(db, `users/${currentUserId}/quizAttempts`);

                try {
                    await push(quizAttemptsRef, {
                        subject: selectedSubjectName,
                        score: correctAnswersCount,
                        totalQuestions: questionsAttempted,
                        accuracy: parseFloat(scorePercentage), 
                        timeTaken: totalTimeTaken,
                        timestamp: serverTimestamp() 
                    });
                    console.log("DB: Quiz results saved to Realtime Database successfully!");

                    // 2. Update daily streak
                    const snapshot = await get(userRef);
                    let currentStreak = 0;
                    let lastQuizDate = null;

                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        currentStreak = userData.currentStreak || 0;
                        lastQuizDate = userData.lastQuizDate ? new Date(userData.lastQuizDate) : null; 
                    }

                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 

                    if (lastQuizDate) {
                        const lastQuizDay = new Date(lastQuizDate);
                        lastQuizDay.setHours(0, 0, 0, 0);

                        const yesterday = new Date(today);
                        yesterday.setDate(today.getDate() - 1);

                        if (lastQuizDay.getTime() === today.getTime()) {
                            console.log("DB: Already played today, streak continues.");
                        } else if (lastQuizDay.getTime() === yesterday.getTime()) {
                            currentStreak++;
                            console.log("DB: Played yesterday, streak incremented to:", currentStreak);
                        } else {
                            currentStreak = 1;
                            console.log("DB: Streak broken, reset to 1.");
                        }
                    } else {
                        currentStreak = 1;
                        console.log("DB: First quiz, streak started at 1.");
                    }

                    // Use update() to only modify the streak and lastQuizDate fields
                    await update(userRef, {
                        currentStreak: currentStreak,
                        lastQuizDate: serverTimestamp() 
                    }); 
                    console.log("DB: Daily streak updated successfully in Realtime Database!");

                } catch (error) {
                    console.error("DB: Error saving quiz results or updating streak to Realtime Database:", error);
                }
            } else {
                console.log("DB: No authenticated user found, skipping saving quiz results and streak update to Realtime Database.");
            }
        }

        /**
         * Fetches an explanation from the Gemini API.
         * @param {string} questionText - The quiz question.
         * @param {string} correctAnswer - The correct answer to the question.
         * @param {string} existingExplanation - Any existing explanation for context.
         * @returns {Promise<string>} A promise that resolves with the Gemini explanation or an error message.
         */
        async function getGeminiExplanation(questionText, correctAnswer, existingExplanation) {
            const prompt = `Provide a detailed explanation for the following multiple-choice question:\n\nQuestion: "${questionText}"\nCorrect Answer: "${correctAnswer}"\n\nExisting Explanation (if any): "${existingExplanation}"\n\nPlease elaborate on why the correct answer is correct and briefly explain why other options might be incorrect. Limit your explanation to approximately 100 words. Focus on clarity and educational value.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyC_fN4BF66NPCP2gqrOFW2wyABV_uwK9Xc"; // User provided API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("GEMINI: API response structure unexpected:", result);
                    return "Could not get a detailed explanation from Gemini. Please try again.";
                }
            } catch (error) {
                console.error("GEMINI: Error calling Gemini API:", error);
                return `Error fetching explanation: ${error.message}. Please check your network connection or try again later.`;
            }
        }

        /**
         * Displays the solutions and explanations for the questions in the quiz.
         */
        function displaySolutions() {
            console.log("SOLUTIONS: Displaying solutions.");
            hideAllContainers(); // Hide all containers
            solutionExplanationContainer.style.display = 'flex';
            solutionsList.innerHTML = ''; 

            if (quizQuestionsAttempted.length === 0) {
                solutionsList.innerHTML = '<p class="text-gray-600">No questions were attempted in the last quiz.</p>';
                return;
            }

            quizQuestionsAttempted.forEach((qData, index) => {
                const solutionItem = document.createElement('div');
                solutionItem.classList.add('solution-item', 'bg-gray-50', 'p-4', 'rounded-lg', 'mb-4', 'text-left', 'border', 'border-gray-200');

                const questionP = document.createElement('p');
                questionP.classList.add('font-bold', 'text-lg', 'mb-2');
                questionP.innerHTML = `Question ${index + 1}: <span class="solution-q-text">${qData.question}</span>`;
                solutionItem.appendChild(questionP);

                const answerP = document.createElement('p');
                answerP.classList.add('mb-2');
                answerP.innerHTML = `Correct Answer: <span class="solution-a-text text-green-600 font-semibold">${qData.answer}</span>`;
                solutionItem.appendChild(answerP);

                const explanationP = document.createElement('p');
                explanationP.classList.add('text-gray-700', 'mb-2');
                explanationP.innerHTML = `Detailed Explanation: <span class="solution-exp-text">${qData.explanation || 'Explanation not available for this question. (Add `explanation` field to your question data in Firebase.)'}</span>`;
                solutionItem.appendChild(explanationP);

                if (qData.learnMoreUrl) {
                    const learnMoreLink = document.createElement('a');
                    learnMoreLink.href = qData.learnMoreUrl;
                    learnMoreLink.textContent = 'Learn More';
                    learnMoreLink.classList.add('solution-learn-more', 'text-blue-600', 'hover:underline', 'block', 'mt-2');
                    learnMoreLink.target = '_blank';
                    solutionItem.appendChild(learnMoreLink);
                } else {
                    const noLearnMore = document.createElement('p');
                    noLearnMore.classList.add('text-gray-500', 'text-sm', 'mt-1');
                    noLearnMore.textContent = 'No "Learn More" link available. (Add `learnMoreUrl` field to your question data in Firebase.)';
                    solutionItem.appendChild(noLearnMore);
                }

                // Add Gemini Explanation Button and Area
                const geminiButton = document.createElement('button');
                geminiButton.textContent = 'Get More Explanation (Gemini)';
                geminiButton.classList.add('glass-button-base', 'glass-button-primary', 'mt-4');
                geminiButton.style.width = 'auto'; // Adjust width for this button
                geminiButton.style.padding = '0.6rem 1rem'; // Adjust padding
                geminiButton.style.fontSize = '0.9rem'; // Adjust font size
                solutionItem.appendChild(geminiButton);

                const geminiExplanationArea = document.createElement('div');
                geminiExplanationArea.classList.add('gemini-explanation-area', 'mt-3');
                geminiExplanationArea.style.display = 'none'; // Hidden by default
                solutionItem.appendChild(geminiExplanationArea);

                geminiButton.addEventListener('click', async () => {
                    geminiButton.disabled = true;
                    geminiButton.textContent = ''; // Clear text
                    const spinner = document.createElement('div');
                    spinner.classList.add('spinner');
                    geminiButton.appendChild(spinner); // Add spinner

                    geminiExplanationArea.style.display = 'block'; // Show area
                    geminiExplanationArea.innerHTML = '<p class="text-center text-gray-400">Generating explanation with Gemini...</p>';
                    console.log("SOLUTIONS: Requesting Gemini explanation for solution...");

                    try {
                        const geminiExp = await getGeminiExplanation(
                            qData.question,
                            qData.answer,
                            qData.explanation || ''
                        );
                        geminiExplanationArea.textContent = geminiExp;
                        console.log("SOLUTIONS: Gemini explanation received and displayed.");
                    } catch (error) {
                        geminiExplanationArea.textContent = `Error: ${error.message}`;
                        geminiExplanationArea.style.color = '#ef4444';
                        console.error("SOLUTIONS: Error getting Gemini explanation:", error);
                    } finally {
                        geminiButton.disabled = false;
                        geminiButton.textContent = 'Get More Explanation (Gemini)'; // Restore text
                        spinner.remove(); // Remove spinner
                    }
                });

                solutionsList.appendChild(solutionItem);
            });
        }

        /**
         * Fetches and displays the user's past quiz attempts and current streak from Realtime Database.
         */
        async function displayUserData() {
            console.log("USER_DATA: displayUserData called.");
            if (!auth.currentUser || !auth.currentUser.uid) {
                console.log("USER_DATA: No user logged in to display data.");
                showAuthError("Please log in to view your activity.");
                return;
            }

            hideAllContainers(); // Hide all containers
            userDataContainer.style.display = 'flex';

            pastAttemptsList.innerHTML = '<p class="text-gray-600">Loading your past quiz attempts...</p>'; 

            const currentUserId = auth.currentUser.uid;
            const userRef = ref(db, `users/${currentUserId}`);
            const quizAttemptsRef = ref(db, `users/${currentUserId}/quizAttempts`);

            try {
                // Fetch current streak
                const userSnapshot = await get(userRef);
                if (userSnapshot.exists()) {
                    const userData = userSnapshot.val();
                    currentStreakDisplay.textContent = userData.currentStreak || 0;
                    console.log("USER_DATA: Fetched streak:", userData.currentStreak);
                } else {
                    currentStreakDisplay.textContent = 0;
                    console.log("USER_DATA: No user data found, streak is 0.");
                }

                // Fetch past quiz attempts, limited to the last 20 for performance
                const attemptsQuery = query(quizAttemptsRef, orderByChild('timestamp'), limitToLast(20));
                const attemptsSnapshot = await get(attemptsQuery);

                if (!attemptsSnapshot.exists() || Object.keys(attemptsSnapshot.val()).length === 0) {
                    pastAttemptsList.innerHTML = '<p class="text-gray-600">No past quiz attempts found.</p>';
                    console.log("USER_DATA: No past quiz attempts found.");
                } else {
                    const attemptsData = attemptsSnapshot.val();
                    const attemptsArray = Object.keys(attemptsData).map(key => ({
                        id: key,
                        ...attemptsData[key]
                    }));

                    // Sort attempts by timestamp in descending order (most recent first)
                    attemptsArray.sort((a, b) => b.timestamp - a.timestamp);

                    let tableHtml = `
                        <table class="user-data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Subject</th>
                                    <th>Score</th>
                                    <th>Total Qs</th>
                                    <th>Accuracy</th>
                                    <th>Time Taken</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    attemptsArray.forEach((data) => {
                        const date = formatTimestamp(data.timestamp);
                        const accuracy = typeof data.accuracy === 'number' ? `${data.accuracy}%` : 'N/A';
                        tableHtml += `
                            <tr>
                                <td>${date}</td>
                                <td>${data.subject || 'N/A'}</td>
                                <td>${data.score || 0}</td>
                                <td>${data.totalQuestions || 0}</td>
                                <td>${accuracy}</td>
                                <td>${data.timeTaken || 0}s</td>
                            </tr>
                        `;
                    });
                    tableHtml += `</tbody></table>`;
                    pastAttemptsList.innerHTML = tableHtml;
                    console.log("USER_DATA: Past quiz attempts displayed.");
                }
            } catch (error) {
                console.error("USER_DATA: Error fetching user data from Realtime Database:", error);
                pastAttemptsList.innerHTML = '<p class="text-red-500">Error loading data. Please try again.</p>';
            }
        }

        /**
         * Fetches and displays the user's profile data, populating editable fields and progress stats.
         */
        async function displayUserProfile() {
            console.log("PROFILE: displayUserProfile called.");
            if (!auth.currentUser || !auth.currentUser.uid) {
                console.log("PROFILE: No user logged in to display profile.");
                showAuthError("Please log in to view your profile.");
                return;
            }

            hideAllContainers(); // Hide all containers
            userProfileContainer.style.display = 'flex';
            profileMessage.style.display = 'none'; 

            const currentUserId = auth.currentUser.uid;
            const userRef = ref(db, `users/${currentUserId}`);
            const quizAttemptsRef = ref(db, `users/${currentUserId}/quizAttempts`);

            try {
                const snapshot = await get(userRef);
                let userData = {};
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    console.log("PROFILE: User data fetched from DB:", userData);
                } else {
                    console.log("PROFILE: No user data found in DB, using Auth data.");
                }

                // Populate editable input fields
                editDisplayNameInput.value = userData.displayName || auth.currentUser.displayName || '';
                editEmailInput.value = userData.email || auth.currentUser.email || '';
                editMobileInput.value = userData.mobile || ''; 
                editAgeInput.value = userData.age || ''; 
                editGenderInput.value = userData.gender || ''; 
                editAboutYouInput.value = userData.aboutYou || ''; 
                profileUserId.textContent = currentUserId;
                profilePhoto.src = userData.photoURL || auth.currentUser.photoURL || "https://placehold.co/120x120/cccccc/333333?text=👤";

                // Calculate and display Progress Stats
                const attemptsSnapshot = await get(quizAttemptsRef);
                let totalAttempts = 0;
                let totalCorrectQuestions = 0;
                let totalQuestionsAcrossAttempts = 0;
                const subjectScores = {}; 

                if (attemptsSnapshot.exists()) {
                    const attemptsData = attemptsSnapshot.val();
                    Object.values(attemptsData).forEach(attempt => {
                        totalAttempts++;
                        totalCorrectQuestions += (attempt.score || 0);
                        totalQuestionsAcrossAttempts += (attempt.totalQuestions || 0);

                        const subject = attempt.subject || 'Unknown';
                        if (!subjectScores[subject]) {
                            subjectScores[subject] = { totalCorrect: 0, totalQuestions: 0 };
                        }
                        subjectScores[subject].totalCorrect += (attempt.score || 0);
                        subjectScores[subject].totalQuestions += (attempt.totalQuestions || 0);
                    });
                    console.log("PROFILE: Quiz attempts data processed.");
                } else {
                    console.log("PROFILE: No quiz attempts found for this user.");
                }

                profileTestsAttempted.textContent = totalAttempts;
                const overallAverageScore = totalQuestionsAcrossAttempts > 0 ? 
                                            ((totalCorrectQuestions / totalQuestionsAcrossAttempts) * 100).toFixed(2) : 0;
                profileAverageScore.textContent = `${overallAverageScore}%`;

                // Determine Weak Areas
                profileWeakAreas.innerHTML = ''; 
                let weakAreasFound = false;
                const WEAK_AREA_THRESHOLD = 60; 

                for (const subject in subjectScores) {
                    const data = subjectScores[subject];
                    if (data.totalQuestions > 0) {
                        const avgScore = (data.totalCorrect / data.totalQuestions) * 100;
                        if (avgScore < WEAK_AREA_THRESHOLD) {
                            const listItem = document.createElement('li');
                            listItem.textContent = `${subject} (${avgScore.toFixed(2)}%)`;
                            profileWeakAreas.appendChild(listItem);
                            weakAreasFound = true;
                        }
                    }
                }

                if (!weakAreasFound) {
                    const listItem = document.createElement('li');
                    listItem.textContent = 'No weak areas identified yet! Keep practicing!';
                    profileWeakAreas.appendChild(listItem);
                }
                console.log("PROFILE: Profile stats and weak areas updated.");

            } catch (error) {
                console.error("PROFILE: Error fetching user profile data or quiz attempts:", error);
                profileMessage.textContent = 'Error loading profile data. Please try again.';
                profileMessage.style.color = '#ef4444';
                profileMessage.style.display = 'block';
                // Fallback to auth data for display if DB fetch fails
                editDisplayNameInput.value = auth.currentUser.displayName || '';
                editEmailInput.value = auth.currentUser.email || '';
                editMobileInput.value = ''; 
                editAgeInput.value = ''; 
                editGenderInput.value = ''; 
                editAboutYouInput.value = ''; 
                profileUserId.textContent = currentUserId;
                profilePhoto.src = auth.currentUser.photoURL || "https://placehold.co/120x120/cccccc/333333?text=�";
                profileTestsAttempted.textContent = 'N/A';
                profileAverageScore.textContent = 'N/A';
                profileWeakAreas.innerHTML = '<li>Error loading weak areas.</li>';
            }
        }

        /**
         * Saves the user's profile data from the editable fields to Realtime Database.
         */
        async function saveUserProfile() {
            console.log("PROFILE: Attempting to save user profile...");
            if (!auth.currentUser || !auth.currentUser.uid) {
                profileMessage.textContent = "Please log in to save your profile.";
                profileMessage.style.color = '#ef4444';
                profileMessage.style.display = 'block';
                return;
            }

            const currentUserId = auth.currentUser.uid;
            const userRef = ref(db, `users/${currentUserId}`);
            const newDisplayName = editDisplayNameInput.value.trim();
            const newEmail = editEmailInput.value.trim();
            const newMobile = editMobileInput.value.trim(); 
            const newAge = editAgeInput.value.trim(); 
            const newGender = editGenderInput.value.trim(); 
            const newAboutYou = editAboutYouInput.value.trim(); 

            const updates = {};
            // Fetch current data from DB to compare and only update changed fields
            let currentDbData = {};
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    currentDbData = snapshot.val();
                }
            } catch (error) {
                console.error("PROFILE: Error fetching current user data for comparison:", error);
                // Continue with updates based on UI values if DB fetch fails for comparison
            }

            if (newDisplayName !== (currentDbData.displayName || auth.currentUser.displayName || '')) {
                updates.displayName = newDisplayName;
            }
            // Note: This updates email in RTDB, not Firebase Auth primary email.
            if (newEmail !== (currentDbData.email || auth.currentUser.email || '')) {
                updates.email = newEmail;
            }
            if (newMobile !== (currentDbData.mobile || '')) {
                updates.mobile = newMobile;
            }
            if (newAge !== (currentDbData.age || '')) {
                updates.age = newAge;
            }
            if (newGender !== (currentDbData.gender || '')) {
                updates.gender = newGender;
            }
            if (newAboutYou !== (currentDbData.aboutYou || '')) {
                updates.aboutYou = newAboutYou;
            }

            if (Object.keys(updates).length === 0) {
                profileMessage.textContent = "No changes to save.";
                profileMessage.style.color = '#4a5568';
                profileMessage.style.display = 'block';
                return;
            }

            try {
                // Update profile in Realtime Database
                await update(userRef, updates);

                // Optionally, update Firebase Authentication profile (only display name is easily updatable this way)
                if (updates.displayName && auth.currentUser) {
                    await updateProfile(auth.currentUser, { displayName: newDisplayName });
                    // Re-fetch user data to update UI with latest auth display name
                    updateUI(auth.currentUser); 
                }

                profileMessage.textContent = "Profile saved successfully!";
                profileMessage.style.color = '#059669';
                profileMessage.style.display = 'block';
                console.log("PROFILE: User profile saved to DB and Auth (if display name changed).");

            } catch (error) {
                console.error("PROFILE: Error saving user profile:", error);
                profileMessage.textContent = `Failed to save profile: ${error.message}`;
                profileMessage.style.color = '#ef4444';
                profileMessage.style.display = 'block';
            }
        }

        /**
         * Displays the settings page.
         */
        function displaySettings() {
            console.log("SETTINGS: displaySettings called.");
            hideAllContainers(); // Hide all containers
            settingsContainer.style.display = 'flex';
        }

        /**
         * Displays the extra features page.
         */
        function displayExtraFeatures() {
            console.log("EXTRA_FEATURES: displayExtraFeatures called.");
            hideAllContainers(); // Hide all containers
            extraFeaturesContainer.style.display = 'flex';
        }


        /**
         * Moves to the next question or ends the quiz if all questions are answered.
         */
        nextButton.addEventListener('click', () => {
            console.log("NAV: Next button clicked. Moving to next question.");
            currentQuestionIndex++;
            displayQuestion();
        });

        // Event listeners for subject selection buttons (old, now mostly unused)
        economyButton.addEventListener('click', () => prepareQuiz("Economy", 'subject-selection-container'));
        politicsButton.addEventListener('click', () => prepareQuiz("Politics", 'subject-selection-container'));
        historyButton.addEventListener('click', () => prepareQuiz("History", 'subject-selection-container'));
        geographyButton.addEventListener('click', () => prepareQuiz("Geography", 'subject-selection-container'));

        // Event listener for the "Start Practice" button
        startPracticeButton.addEventListener('click', startActualQuiz);

        // Event listener for the new "Show Result" button
        showResultButton.addEventListener('click', endQuiz);

        // Event listener for the "View My Activity" button
        viewActivityButton.addEventListener('click', displayUserData);

        // Event listener for the "View My Profile" button
        viewProfileButton.addEventListener('click', displayUserProfile); 

        // Event listener for the "Save Profile" button
        saveProfileButton.addEventListener('click', saveUserProfile);

        // Event listener for the "Go to Settings" button
        goToSettingsButton.addEventListener('click', displaySettings);

        // Event listener for the "Extra Features" button
        extraFeaturesButton.addEventListener('click', displayExtraFeatures);

        // Event listener for the "Back to Quiz Selection" button (from Activity)
        backToQuizSelectionButton.addEventListener('click', initQuiz); 

        // Event listener for the "Back to Quiz Selection" button (from Profile)
        backToSubjectSelectionFromProfileButton.addEventListener('click', initQuiz); 

        // Event listener for "Back to Profile" button (from Settings)
        backToProfileFromSettingsButton.addEventListener('click', displayUserProfile);

        // Event listener for "Back to Home" button (from Extra Features)
        backToHomeFromExtraFeaturesButton.addEventListener('click', initQuiz);

        // Event listeners for Result Summary Page buttons
        retryTestButton.addEventListener('click', () => {
            console.log("NAV: Retry Test button clicked. Navigating to home screen.");
            initQuiz(); // Go back to the home screen
        });
        viewSolutionsButton.addEventListener('click', () => {
            displaySolutions(); // Call the new function to show solutions
        });
        shareScoreButton.addEventListener('click', async () => { // Made async
            console.log("SHARE: Share Score button clicked.");
            const score = resultScorePercentage.textContent;
            const subject = resultSubject.textContent;
            const message = `I scored ${score} in the ${subject} quiz on SSC Prep App! Can you beat me? #SSCPrep #Quiz`;
            
            if (navigator.share) {
                console.log("SHARE: Using Web Share API.");
                try {
                    await navigator.share({
                        title: 'My Quiz Score',
                        text: message,
                    });
                    console.log('SHARE: Share successful');
                } catch (error) {
                    console.error('SHARE: Error sharing via Web Share API:', error);
                    // Fallback to clipboard if Web Share API fails or is cancelled
                    if (error.name !== 'AbortError') { // Ignore user cancellation
                        console.log("SHARE: Web Share API failed, attempting clipboard copy.");
                        try {
                            await navigator.clipboard.writeText(message);
                            console.log(`SHARE: Score copied to clipboard successfully! Share this:\n"${message}"`);
                        } catch (clipboardError) {
                            console.error('SHARE: Failed to copy text to clipboard:', clipboardError);
                            console.log("SHARE: Automatic copy failed. Please manually copy the message from console:");
                            console.log(message);
                        }
                    }
                }
            } else if (navigator.clipboard && navigator.clipboard.writeText) {
                console.log("SHARE: Web Share API not supported, using navigator.clipboard.writeText().");
                try {
                    await navigator.clipboard.writeText(message);
                    console.log(`SHARE: Score copied to clipboard successfully! Share this:\n"${message}"`);
                } catch (clipboardError) {
                    console.error('SHARE: Failed to copy text to clipboard:', clipboardError);
                    console.log("SHARE: Automatic copy failed. Please manually copy the message from console:");
                    console.log(message);
                }
            } else {
                // Final fallback for older browsers or highly restricted environments
                console.log("SHARE: Neither Web Share API nor navigator.clipboard.writeText() supported. Falling back to temporary textarea copy.");
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = message;
                tempTextArea.style.position = 'absolute';
                tempTextArea.style.left = '-9999px';
                tempTextArea.style.top = '0';
                document.body.appendChild(tempTextArea);
                
                tempTextArea.select();
                
                try {
                    document.execCommand('copy');
                    console.log(`SHARE: Score copied to clipboard using execCommand! Share this:\n"${message}"`);
                } catch (err) {
                    console.error('SHARE: Failed to copy text using execCommand:', err);
                    console.log("SHARE: Failed to automatically copy to clipboard. Please manually copy the message:");
                    console.log(message);
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            }
        });

        // New event listener for "Back to Results" button on Solution/Explanation page
        backToResultsButton.addEventListener('click', () => {
            console.log("NAV: Back to Results button clicked.");
            hideAllContainers();
            resultSummaryContainer.style.display = 'flex'; // Show the result summary again
        });

        // Placeholder for settings page actions (can be expanded later)
        changePasswordButton.addEventListener('click', () => console.log('SETTINGS: Change Password functionality coming soon!'));
        notificationsToggle.addEventListener('change', (event) => console.log('SETTINGS: Notifications toggled:', event.target.checked));
        languageSelect.addEventListener('change', (event) => console.log('SETTINGS: Language changed to:', event.target.value));
        helpFeedbackButton.addEventListener('click', () => console.log('SETTINGS: Help and Feedback functionality coming soon!'));


        // Attach event listeners after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("APP_START: DOM Content Loaded. Attaching primary event listeners.");

            // Initialize Firebase app, auth, and db here
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);

            // Firebase Auth State Listener - moved here to ensure 'auth' is defined
            onAuthStateChanged(auth, async (user) => {
                console.log("AUTH_STATE: onAuthStateChanged fired. Current user:", user ? user.uid : "null"); // Added log
                // If there's an initial token and no user is logged in yet, try to sign in with it
                if (typeof __initial_auth_token !== 'undefined' && user === null) {
                    try {
                        console.log("AUTH_STATE: Attempting signInWithCustomToken..."); // Added log
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("AUTH_STATE: Signed in with custom token successfully."); // Added log
                    } catch (error) {
                        console.error("AUTH_STATE: Error signing in with custom token:", error); // Added log
                        // Fallback to anonymous if custom token fails
                        console.log("AUTH_STATE: Falling back to anonymous sign-in..."); // Added log
                        await signInAnonymously(auth);
                    }
                } else {
                    // User is already logged in or just logged in via custom token/anonymous
                    console.log("AUTH_STATE: User state updated, calling updateUI."); // Added log
                    updateUI(user);
                }
            });

            // Call initQuiz to start the splash screen flow
            initQuiz(); 

            // Get references to elements that are guaranteed to be in the DOM now
            logoutButtons = document.querySelectorAll('.logout-button-class');
            console.log("APP_START: Found logout buttons:", logoutButtons.length);

            // Attach event listeners for login/logout buttons
            anonymousLoginButton.addEventListener('click', loginAnonymously);
            googleLoginButton.addEventListener('click', signInWithGoogle);
            appleLoginButton.addEventListener('click', signInWithApple); // Apple login listener
            
            emailLoginButton.addEventListener('click', signInWithEmailPassword);
            forgotPasswordButton.addEventListener('click', handleForgotPassword); 
            emailSignupButton.addEventListener('click', signUpWithEmailPassword); 
            googleSignupButton.addEventListener('click', signInWithGoogle); // Google signup listener
            appleSignupButton.addEventListener('click', signInWithApple); // Apple signup listener

            showLoginButton.addEventListener('click', () => toggleAuthForms('login'));
            showSignupButton.addEventListener('click', () => toggleAuthForms('signup'));

            // Home Screen button listeners
            cardGeneralAwareness.addEventListener('click', () => {
                hideAllContainers();
                gaSubjectsContainer.style.display = 'flex'; // Show GA subjects container
            });
            cardReasoning.addEventListener('click', () => {
                hideAllContainers();
                reasoningSubjectsContainer.style.display = 'flex';
            });
            cardQuantitativeAptitude.addEventListener('click', () => {
                hideAllContainers();
                quantitativeAptitudeSubjectsContainer.style.display = 'flex';
            });
            cardEnglishLanguage.addEventListener('click', () => {
                hideAllContainers();
                englishLanguageSubjectsContainer.style.display = 'flex';
            });
            cardComputerKnowledge.addEventListener('click', () => {
                hideAllContainers();
                computerKnowledgeSubjectsContainer.style.display = 'flex';
            });
            cardGeneralStudies.addEventListener('click', () => {
                hideAllContainers();
                generalStudiesSubjectsContainer.style.display = 'flex';
            });
            cardCurrentAffairs.addEventListener('click', () => {
                hideAllContainers();
                currentAffairsSubjectsContainer.style.display = 'flex';
            });
            cardMockTestZone.addEventListener('click', () => {
                hideAllContainers();
                mockTestZoneSubjectsContainer.style.display = 'flex';
            });
            extraFeaturesButton.addEventListener('click', displayExtraFeatures);

            // GA Sub-subject button listeners
            gaStaticGkButton.addEventListener('click', () => prepareQuiz("Static GK", 'ga-subjects-container'));
            gaCurrentAffairsButton.addEventListener('click', () => prepareQuiz("Current Affairs", 'ga-subjects-container'));
            gaPolityButton.addEventListener('click', () => prepareQuiz("Polity", 'ga-subjects-container'));
            gaHistoryButton.addEventListener('click', () => prepareQuiz("History", 'ga-subjects-container'));
            gaGeographyButton.addEventListener('click', () => prepareQuiz("Geography", 'ga-subjects-container'));
            gaScienceButton.addEventListener('click', () => prepareQuiz("Science", 'ga-subjects-container'));
            gaEconomyButton.addEventListener('click', () => prepareQuiz("Economy", 'ga-subjects-container'));
            backToHomeFromGaSubjectsButton.addEventListener('click', initQuiz); // Back to home

            // Reasoning Sub-subject button listeners
            reasoningAnalogyButton.addEventListener('click', () => prepareQuiz("Analogy", 'reasoning-subjects-container'));
            reasoningSeriesButton.addEventListener('click', () => prepareQuiz("Series", 'reasoning-subjects-container'));
            reasoningPuzzlesButton.addEventListener('click', () => prepareQuiz("Puzzles", 'reasoning-subjects-container'));
            reasoningCodingDecodingButton.addEventListener('click', () => prepareQuiz("Coding-Decoding", 'reasoning-subjects-container'));
            reasoningBloodRelationsButton.addEventListener('click', () => prepareQuiz("Blood Relations", 'reasoning-subjects-container'));
            backToHomeFromReasoningSubjectsButton.addEventListener('click', initQuiz);

            // Quantitative Aptitude Sub-subject button listeners
            quantArithmeticButton.addEventListener('click', () => prepareQuiz("Arithmetic", 'quantitative-aptitude-subjects-container'));
            quantAlgebraButton.addEventListener('click', () => prepareQuiz("Algebra", 'quantitative-aptitude-subjects-container'));
            quantGeometryButton.addEventListener('click', () => prepareQuiz("Geometry", 'quantitative-aptitude-subjects-container'));
            quantMensurationButton.addEventListener('click', () => prepareQuiz("Mensuration", 'quantitative-aptitude-subjects-container'));
            quantTrigonometryButton.addEventListener('click', () => prepareQuiz("Trigonometry", 'quantitative-aptitude-subjects-container'));
            quantDiButton.addEventListener('click', () => prepareQuiz("Data Interpretation", 'quantitative-aptitude-subjects-container'));
            backToHomeFromQuantSubjectsButton.addEventListener('click', initQuiz);

            // English Language Sub-subject button listeners
            englishVocabularyButton.addEventListener('click', () => prepareQuiz("Vocabulary", 'english-language-subjects-container'));
            englishGrammarButton.addEventListener('click', () => prepareQuiz("Grammar", 'english-language-subjects-container'));
            englishReadingComprehensionButton.addEventListener('click', () => prepareQuiz("Reading Comprehension", 'english-language-subjects-container'));
            englishClozeTestButton.addEventListener('click', () => prepareQuiz("Cloze Test", 'english-language-subjects-container'));
            englishSpotErrorButton.addEventListener('click', () => prepareQuiz("Spot the Error", 'english-language-subjects-container'));
            backToHomeFromEnglishSubjectsButton.addEventListener('click', initQuiz);

            // Computer Knowledge Sub-subject button listeners
            computerBasicsButton.addEventListener('click', () => prepareQuiz("Basics of Computer", 'computer-knowledge-subjects-container'));
            computerInternetButton.addEventListener('click', () => prepareQuiz("Internet", 'computer-knowledge-subjects-container'));
            computerMsOfficeButton.addEventListener('click', () => prepareQuiz("MS Office", 'computer-knowledge-subjects-container'));
            computerAbbreviationsButton.addEventListener('click', () => prepareQuiz("Abbreviations", 'computer-knowledge-subjects-container'));
            backToHomeFromComputerSubjectsButton.addEventListener('click', initQuiz);

            // General Studies Sub-subject button listeners
            gsEngineeringButton.addEventListener('click', () => prepareQuiz("Engineering Subjects", 'general-studies-subjects-container'));
            gsAdvancedEconomyButton.addEventListener('click', () => prepareQuiz("Advanced Economics", 'general-studies-subjects-container'));
            gsAdvancedPolityButton.addEventListener('click', () => prepareQuiz("Advanced Polity", 'general-studies-subjects-container'));
            backToHomeFromGeneralStudiesSubjectsButton.addEventListener('click', initQuiz);

            // Current Affairs Sub-subject button listeners
            caDailyQuizzesButton.addEventListener('click', () => prepareQuiz("Daily Quizzes", 'current-affairs-subjects-container'));
            caBudgetButton.addEventListener('click', () => prepareQuiz("Budget", 'current-affairs-subjects-container'));
            caGovtSchemesButton.addEventListener('click', () => prepareQuiz("Government Schemes", 'current-affairs-subjects-container'));
            caMonthlyPdfsButton.addEventListener('click', () => prepareQuiz("Monthly PDFs", 'current-affairs-subjects-container'));
            backToHomeFromCurrentAffairsSubjectsButton.addEventListener('click', initQuiz);

            // Mock Test Zone Sub-subject button listeners
            mtzFullLengthMocksButton.addEventListener('click', () => prepareQuiz("Full Length Mocks", 'mock-test-zone-subjects-container'));
            mtzSectionalTestsButton.addEventListener('click', () => prepareQuiz("Sectional Tests", 'mock-test-zone-subjects-container'));
            mtzTierWiseTestsButton.addEventListener('click', () => prepareQuiz("Tier-wise Tests", 'mock-test-zone-subjects-container'));
            backToHomeFromMockTestZoneSubjectsButton.addEventListener('click', initQuiz);


            // Event listener for the new home screen profile icon (now in global header)
            headerProfilePhoto.addEventListener('click', displayUserProfile);

            logoutButtons.forEach((button, index) => {
                button.addEventListener('click', logoutUser);
                console.log(`APP_START: Logout button ${index + 1} listener attached.`);
            });

            // New back button event listeners
            backToSubjectSelectionFromQuestionCountButton.addEventListener('click', () => {
                console.log(`NAV: Back from question count to: ${lastQuizSetupScreen}`);
                hideAllContainers();
                // Show the screen that led to question count
                if (lastQuizSetupScreen && document.getElementById(lastQuizSetupScreen)) {
                    document.getElementById(lastQuizSetupScreen).style.display = 'flex';
                } else {
                    // Fallback if lastQuizSetupScreen is not set or invalid
                    initQuiz(); // Go back to home screen
                }
            });

            backToQuestionCountFromQuizButton.addEventListener('click', () => {
                console.log("NAV: Back from quiz to question count.");
                clearInterval(timerInterval); // Stop timer if active
                hideAllContainers();
                questionCountContainer.style.display = 'flex';
                // Re-enable start practice button if it was disabled
                startPracticeButton.disabled = false;
                questionCountError.style.display = 'none'; // Clear any previous error
            });

            backToQuestionCountFromResultButton.addEventListener('click', () => {
                console.log("NAV: Back from result to question count.");
                hideAllContainers();
                questionCountContainer.style.display = 'flex';
                startPracticeButton.disabled = false;
                questionCountError.style.display = 'none';
            });
        });
    </script>
</body>
</html>
�
